<!doctype html><html lang=en-us><head><meta charset=utf-8><title>Spring Boot Kubernetes ConfigMap | c3smonkey's blog</title><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Now is time to configure our microservices to send the tracing logs to Jaeger 1. The configuration opentracing.jaeger.http-sender.url in configuration application.yaml file looks like below in the sources.
opentracing: jaeger: log-spans: true http-sender: url: http://localhost:14268/api/traces The opentracing.jaeger.http-sender.url we are looking for we get form the section Get Route Host in the Jaeger post We will use the ConfigMap approach with the Spring Cloud Kubernetes{:target=&#34;_blank&#34;} starters.
Maven Update Maven Configuration with Spring Cloud Kubernetes{:target=&#34;_blank&#34;} library."><meta name=author content="Marcel Widmer"><link rel=canonical href=https://blog.marcelwidmer.org/blog/2019/2019-09-18-spring-boot-k8s-configmap/><link rel=stylesheet href=https://blog.marcelwidmer.org/sass/main.min.css><link rel=stylesheet href=https://blog.marcelwidmer.org/sass/nav.min.css><link rel=stylesheet href=https://blog.marcelwidmer.org/plugins/css/pico.min.css><script defer crossorigin=anonymous src=/assets/js/highlight.min.b95bacdc39e37a332a9f883b1e78be4abc1fdca2bc1f2641f55e3cd3dabd4d61.js integrity="sha256-uVus3DnjejMqn4g7Hni+Srwf3KK8HyZB9V4809q9TWE=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://blog.marcelwidmer.org/static/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blog.marcelwidmer.org/static/favicon.ico><link rel=icon type=image/png sizes=32x32 href=https://blog.marcelwidmer.org/static/favicon.ico><link rel=apple-touch-icon href=https://blog.marcelwidmer.org/static/favicon.ico><link rel=mask-icon href=https://blog.marcelwidmer.org/static/favicon.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.104.0"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.marcelwidmer.org/static"><meta name=twitter:title content="Spring Boot Kubernetes ConfigMap"><meta name=twitter:description content="Now is time to configure our microservices to send the tracing logs to Jaeger 1. The configuration opentracing.jaeger.http-sender.url in configuration application.yaml file looks like below in the sources.
opentracing: jaeger: log-spans: true http-sender: url: http://localhost:14268/api/traces The opentracing.jaeger.http-sender.url we are looking for we get form the section Get Route Host in the Jaeger post We will use the ConfigMap approach with the Spring Cloud Kubernetes{:target=&#34;_blank&#34;} starters.
Maven Update Maven Configuration with Spring Cloud Kubernetes{:target=&#34;_blank&#34;} library."><meta property="og:title" content="Spring Boot Kubernetes ConfigMap"><meta property="og:description" content="Now is time to configure our microservices to send the tracing logs to Jaeger 1. The configuration opentracing.jaeger.http-sender.url in configuration application.yaml file looks like below in the sources.
opentracing: jaeger: log-spans: true http-sender: url: http://localhost:14268/api/traces The opentracing.jaeger.http-sender.url we are looking for we get form the section Get Route Host in the Jaeger post We will use the ConfigMap approach with the Spring Cloud Kubernetes{:target=&#34;_blank&#34;} starters.
Maven Update Maven Configuration with Spring Cloud Kubernetes{:target=&#34;_blank&#34;} library."><meta property="og:type" content="article"><meta property="og:url" content="https://blog.marcelwidmer.org/blog/2019/2019-09-18-spring-boot-k8s-configmap/"><meta property="og:image" content="https://blog.marcelwidmer.org/static"><meta property="article:section" content="blog"><meta property="article:published_time" content="2019-09-18T00:00:00+00:00"><meta property="article:modified_time" content="2019-09-18T00:00:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.marcelwidmer.org/static"><meta name=twitter:title content="Spring Boot Kubernetes ConfigMap"><meta name=twitter:description content="Now is time to configure our microservices to send the tracing logs to Jaeger 1. The configuration opentracing.jaeger.http-sender.url in configuration application.yaml file looks like below in the sources.
opentracing: jaeger: log-spans: true http-sender: url: http://localhost:14268/api/traces The opentracing.jaeger.http-sender.url we are looking for we get form the section Get Route Host in the Jaeger post We will use the ConfigMap approach with the Spring Cloud Kubernetes{:target=&#34;_blank&#34;} starters.
Maven Update Maven Configuration with Spring Cloud Kubernetes{:target=&#34;_blank&#34;} library."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Blog","item":"https://blog.marcelwidmer.org/blog/"},{"@type":"ListItem","position":3,"name":"Spring Boot Kubernetes ConfigMap","item":"https://blog.marcelwidmer.org/blog/2019/2019-09-18-spring-boot-k8s-configmap/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Spring Boot Kubernetes ConfigMap","name":"Spring Boot Kubernetes ConfigMap","description":"Now is time to configure our microservices to send the tracing logs to Jaeger 1. The configuration opentracing.jaeger.http-sender.url in configuration application.yaml file looks like below in the sources.\nopentracing: jaeger: log-spans: true http-sender: url: http://localhost:14268/api/traces The opentracing.jaeger.http-sender.url we are looking for we get form the section Get Route Host in the Jaeger post We will use the ConfigMap approach with the Spring Cloud Kubernetes{:target=\u0026quot;_blank\u0026quot;} starters.\nMaven Update Maven Configuration with Spring Cloud Kubernetes{:target=\u0026quot;_blank\u0026quot;} library.","keywords":["k8s","ConfigMap","Spring Boot"],"articleBody":"Now is time to configure our microservices to send the tracing logs to Jaeger 1. The configuration opentracing.jaeger.http-sender.url in configuration application.yaml file looks like below in the sources.\nopentracing: jaeger: log-spans: true http-sender: url: http://localhost:14268/api/traces The opentracing.jaeger.http-sender.url we are looking for we get form the section Get Route Host in the Jaeger post We will use the ConfigMap approach with the Spring Cloud Kubernetes{:target=\"_blank\"} starters.\nMaven Update Maven Configuration with Spring Cloud Kubernetes{:target=\"_blank\"} library.\nDependency Management spring-cloud-dependencies org.springframework.cloud spring-cloud-dependencies ${spring-cloud.version} pom import Spring Cloud Version spring-cloud.version ... Greenwich.SR3 Dependency spring-cloud-starter-kubernetes-config org.springframework.cloud spring-cloud-starter-kubernetes-config Application Configuration The application may need to detect changes on external property sources and update their internal status to reflect the new configuration. The reload feature of Spring Cloud Kubernetes is able to trigger an application reload when a related ConfigMap changes.\nThis feature is disabled by default and can be enabled using the configuration property spring.cloud.kubernetes.reload.enabled=true in the application.yaml file.\nThe configuration spring.cloud.kubernetes.reload.strategy=restart_context will restart the whole Spring ApplicationContext gracefully.\nspring: cloud: kubernetes: reload: enabled: true strategy: restart_context Configure the management.endpoint.restart.enabled=true\nmanagement: endpoint: restart: enabled: true Configured Service Account - RBAC policy To read the ConfigMap we have to give to the Service Account{:target=\"_blank\"} in the default namespace access right. This can be done to give just view access oc policy add-role-to-user view system:serviceaccount:development:default\nThe better solution is configure ClusterRole\n⚠️ Avoid no RBAC policy match exception:\n.fabric8.kubernetes.client.KubernetesClientException: Failure executing: GET at: https://172.30.0.1/api/v1/namespaces/development/pods/order-service-35-wj25f. Message: Forbidden!Configured service account doesnt have access. Service account may have been revoked. pods “order-service-35-wj25f” is forbidden: User “system:serviceaccount:development:default” cannot get pods in the namespace “development”: no RBAC policy matched.\nCreate ClusterRole Additional you can also create a ClusterRole for Spring components let it named spring-roles. Create a file service-account-for-spring-cloud-k8s-access.yaml\nkind: ClusterRole apiVersion: rbac.authorization.k8s.io/v1 metadata: namespace: default name: spring-roles rules: - apiGroups: [\"\"] # \"\" indicates the core API group resources: [\"pods\",\"configmaps\"] verbs: [\"get\", \"list\", \"watch\"] --- apiVersion: rbac.authorization.k8s.io/v1beta1 kind: ClusterRoleBinding metadata: name: allow-spring-to-access-cluster subjects: - kind: ServiceAccount name: default namespace: default roleRef: kind: ClusterRole name: spring-roles apiGroup: rbac.authorization.k8s.io Login in with privileged user oc login -u .\n$ oc apply -f service-account-for-spring-cloud-k8s-access.yaml Now when you check che Cluster Console under Administration/Roles and you search for spring you will find the role.\nDeploy ConfigMap Now is time to create our ConfigMap and apply it in the development namespace for the oder-service You can do it directly in a shell.\n$ echo \"apiVersion: v1 kind: ConfigMap metadata: # matches the spring app name as defined in application.yml name: order-service data: # must be named 'application.yaml' or be the only key in this config # refer to Spring Cloud Kubernetes Config documentation or source code application.yaml: | opentracing: jaeger: http-sender: url: http://jaeger-collector-jaeger.apps.c3smonkey.ch/api/traces\" | oc apply -f - Better is you create a ConfigMap file and then you use the apply command.\n$ oc apply -f deployments/configmap.yaml When you hit the service again you will see some traces in the Jaeger now.\n$ for x in (seq 50); http \"http://order-service-development.apps.c3smonkey.ch/api/v1/orders/random\"; end jaegertracing.io ↩︎\n","wordCount":"509","inLanguage":"en","datePublished":"2019-09-18T00:00:00Z","dateModified":"2019-09-18T00:00:00Z","author":{"@type":"Person","name":"Marcel Widmer"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.marcelwidmer.org/blog/2019/2019-09-18-spring-boot-k8s-configmap/"},"publisher":{"@type":"Organization","name":"c3smonkey's blog","logo":{"@type":"ImageObject","url":"https://blog.marcelwidmer.org/static/favicon.ico"}}}</script></head><body><nav class=desktop><ul><li><a class=logo href=https://blog.marcelwidmer.org accesskey=h title="Welcome to my blog (Alt + h)"><img src=/static/favicon.ico alt="Welcome to my blog" width=35 height=35></img><h3 style=margin-bottom:0><strong><em>c3smonkey&rsquo;s blog</em></strong></h3></a></li><li class=toggle-container><input type=checkbox id=switch>
<label for=switch><i id=darkIcon data-feather=moon></i>
<i id=lightIcon data-feather=sun></i></label></li></ul><ul class=desktop-navigation><li><a href=/blog title=Blog><i data-feather=pen-tool></i>
<span>Blog</span></a></li><li><a href=/search title="Search (Alt + /)" accesskey=/><i data-feather=search></i>
<span>Search</span></a></li><li><a href=/contact title=Contact><i data-feather=mail></i>
<span>Contact</span></a></li><li><a href=https://github.com/marzelwidmer title=Github><i data-feather=github></i>
<span></span></a></li></ul><ul class=mobile-navigation><li><button id=menuOpen onclick=openMobile() aria-label="Menu closed">
<i data-feather=menu></i></button>
<button id=menuClose onclick=openMobile() aria-label="Menu opened">
<i data-feather=x></i></button></li></ul></nav><aside class=sidebar id=mobileNav style=display:none><nav><ul><li><a href=/blog title=Blog><span><i data-feather=pen-tool></i>
Blog</span></a></li><li><a href=/search title="Search (Alt + /)" accesskey=/><span><i data-feather=search></i>
Search</span></a></li><li><a href=/contact title=Contact><span><i data-feather=mail></i>
Contact</span></a></li><li><a href=https://github.com/marzelwidmer title=Github><span><i data-feather=github></i></span></a></li></ul></nav></aside><main><div class=container><hgroup><div><a href=https://blog.marcelwidmer.org>Home</a>&nbsp;»&nbsp;<a href=https://blog.marcelwidmer.org/blog/>Blog</a></div><h1>Spring Boot Kubernetes ConfigMap</h1><time datetime='2019-09-18 00:00:00 +0000 UTC'>September 18, 2019</time>&nbsp;·&nbsp;3 min&nbsp;·&nbsp;Marcel Widmer<p></p></hgroup><a href=https://blog.marcelwidmer.org/tags/k8s/><kbd>k8s</kbd></a>
<a href=https://blog.marcelwidmer.org/tags/configmap/><kbd>ConfigMap</kbd></a>
<a href=https://blog.marcelwidmer.org/tags/spring-boot/><kbd>Spring Boot</kbd></a><div class="grid grid-main"><div><article class=toc><div><details open><summary accesskey=c title="(Alt + C)"><span>Table of Contents</span></summary><div><ul><ul><li><a href=#maven-a-namemavenconfigurationa aria-label="Maven ">Maven</a><ul><li><a href=#dependency-management-spring-cloud-dependencies aria-label="Dependency Management spring-cloud-dependencies">Dependency Management <code>spring-cloud-dependencies</code></a></li><li><a href=#spring-cloud-version-spring-cloudversion aria-label="Spring Cloud Version spring-cloud.version">Spring Cloud Version <code>spring-cloud.version</code></a></li><li><a href=#dependency-spring-cloud-starter-kubernetes-config aria-label="Dependency spring-cloud-starter-kubernetes-config">Dependency <code>spring-cloud-starter-kubernetes-config</code></a></li></ul></li><li><a href=#application-configuration aria-label="Application Configuration">Application Configuration</a></li><li><a href=#configured-service-account---rbac-policy aria-label="Configured Service Account - RBAC policy">Configured Service Account - RBAC policy</a></li></ul><li><a href=#create-clusterrole aria-label="Create ClusterRole">Create ClusterRole</a><ul><li><a href=#deploy-configmap aria-label="Deploy ConfigMap">Deploy ConfigMap</a></li></ul></li></ul></div></details></div></article><div class=post><div class=share-buttons></div><p>Now is time to configure our <a href=https://github.com/marzelwidmer/microservices-demo target=_blank rel=noopener>microservices</a> to send the tracing
logs to Jaeger <sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>.
The configuration <code>opentracing.jaeger.http-sender.url</code> in configuration <code>application.yaml</code> file looks like below in the sources.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>opentracing</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>jaeger</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>log-spans</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>http-sender</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>url</span>: <span style=color:#ae81ff>http://localhost:14268/api/traces</span>
</span></span></code></pre></div><p>The <code>opentracing.jaeger.http-sender.url</code> we are looking for we get form the section <a href=http://blog.marcelwidmer.org/jaeger/#GetRouteHost target=_blank rel=noopener>Get Route Host in the Jaeger post</a>
We will use the <code>ConfigMap</code> approach with the <a href=https://spring.io/projects/spring-cloud-kubernetes target=_blank rel=noopener>Spring Cloud Kubernetes</a>{:target="_blank"} starters.</p><h2 id=maven-a-namemavenconfigurationa>Maven <a class=anchor aria-hidden=true href=#maven-a-namemavenconfigurationa>#</a></h2><p>Update Maven Configuration with <a href=https://cloud.spring.io/spring-cloud-static/spring-cloud-kubernetes/1.0.3.RELEASE/single/spring-cloud-kubernetes.html target=_blank rel=noopener>Spring Cloud Kubernetes</a>{:target="_blank"} library.</p><h3 id=dependency-management-spring-cloud-dependencies>Dependency Management <code>spring-cloud-dependencies</code><a class=anchor aria-hidden=true href=#dependency-management-spring-cloud-dependencies>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#f92672>&lt;dependencyManagement&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;dependencies&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;groupId&gt;</span>org.springframework.cloud<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;artifactId&gt;</span>spring-cloud-dependencies<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;version&gt;</span>${spring-cloud.version}<span style=color:#f92672>&lt;/version&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;type&gt;</span>pom<span style=color:#f92672>&lt;/type&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;scope&gt;</span>import<span style=color:#f92672>&lt;/scope&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/dependencies&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependencyManagement&gt;</span>
</span></span></code></pre></div><h3 id=spring-cloud-version-spring-cloudversion>Spring Cloud Version <code>spring-cloud.version</code><a class=anchor aria-hidden=true href=#spring-cloud-version-spring-cloudversion>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#f92672>&lt;properties&gt;</span>
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;spring-cloud.version&gt;</span>Greenwich.SR3<span style=color:#f92672>&lt;/spring-cloud.version&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/properties&gt;</span>
</span></span></code></pre></div><h3 id=dependency-spring-cloud-starter-kubernetes-config>Dependency <code>spring-cloud-starter-kubernetes-config</code><a class=anchor aria-hidden=true href=#dependency-spring-cloud-starter-kubernetes-config>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#75715e>&lt;!-- Kubernetes --&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>org.springframework.cloud<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>spring-cloud-starter-kubernetes-config<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span></code></pre></div><h2 id=application-configuration>Application Configuration<a class=anchor aria-hidden=true href=#application-configuration>#</a></h2><p>The application may need to detect changes on external property sources and update their internal status to reflect the new configuration.
The reload feature of <code>Spring Cloud Kubernetes</code> is able to trigger an application reload when a related <code>ConfigMap</code> changes.</p><p>This feature is disabled by default and can be enabled using the configuration property <code>spring.cloud.kubernetes.reload.enabled=true</code>
in the <code>application.yaml</code> file.</p><p>The configuration <code>spring.cloud.kubernetes.reload.strategy=restart_context</code> will restart the whole Spring ApplicationContext gracefully.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>spring</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>cloud</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>kubernetes</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>reload</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>strategy</span>: <span style=color:#ae81ff>restart_context</span>
</span></span></code></pre></div><p>Configure the <code>management.endpoint.restart.enabled=true</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>management:
</span></span><span style=display:flex><span>  endpoint:
</span></span><span style=display:flex><span>    restart:
</span></span><span style=display:flex><span>      enabled: true
</span></span></code></pre></div><h2 id=configured-service-account---rbac-policy>Configured Service Account - RBAC policy<a class=anchor aria-hidden=true href=#configured-service-account---rbac-policy>#</a></h2><p>To read the <code>ConfigMap</code> we have to give to the <a href=https://cloud.spring.io/spring-cloud-static/spring-cloud-kubernetes/1.1.0.M2/reference/html/#_service_account target=_blank rel=noopener>Service Account</a>{:target="_blank"} in the default namespace access right. This can be done to give just
<code>view</code> access <code>oc policy add-role-to-user view system:serviceaccount:development:default</code></p><p>The better solution is <a href=#ConfigureClusterRole>configure ClusterRole</a></p><blockquote><p>⚠️ <strong>Avoid no RBAC policy match exception</strong>:<br>.fabric8.kubernetes.client.KubernetesClientException:
Failure executing: GET at: https://172.30.0.1/api/v1/namespaces/development/pods/order-service-35-wj25f.
Message: Forbidden!Configured service account doesnt have access.
Service account may have been revoked. pods &ldquo;order-service-35-wj25f&rdquo; is
forbidden: User &ldquo;system:serviceaccount:development:default&rdquo; cannot get pods in the namespace &ldquo;development&rdquo;: no RBAC policy matched.</p></blockquote><h1 id=create-clusterrole>Create ClusterRole<a class=anchor aria-hidden=true href=#create-clusterrole>#</a></h1><p>Additional you can also create a <code>ClusterRole</code> for Spring components let it named <code>spring-roles</code>.
Create a file <code>service-account-for-spring-cloud-k8s-access.yaml</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>ClusterRole</span>
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>rbac.authorization.k8s.io/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>default</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>spring-roles</span>
</span></span><span style=display:flex><span><span style=color:#f92672>rules</span>:
</span></span><span style=display:flex><span>- <span style=color:#f92672>apiGroups</span>: [<span style=color:#e6db74>&#34;&#34;</span>] <span style=color:#75715e># &#34;&#34; indicates the core API group</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>resources</span>: [<span style=color:#e6db74>&#34;pods&#34;</span>,<span style=color:#e6db74>&#34;configmaps&#34;</span>]
</span></span><span style=display:flex><span>  <span style=color:#f92672>verbs</span>: [<span style=color:#e6db74>&#34;get&#34;</span>, <span style=color:#e6db74>&#34;list&#34;</span>, <span style=color:#e6db74>&#34;watch&#34;</span>]
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>rbac.authorization.k8s.io/v1beta1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>ClusterRoleBinding</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>allow-spring-to-access-cluster</span>
</span></span><span style=display:flex><span><span style=color:#f92672>subjects</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>kind</span>: <span style=color:#ae81ff>ServiceAccount</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>default</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>default</span>
</span></span><span style=display:flex><span><span style=color:#f92672>roleRef</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>kind</span>: <span style=color:#ae81ff>ClusterRole</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>spring-roles</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>apiGroup</span>: <span style=color:#ae81ff>rbac.authorization.k8s.io</span>
</span></span></code></pre></div><p>Login in with privileged user <code>oc login -u &lt;privileged user></code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ oc apply -f service-account-for-spring-cloud-k8s-access.yaml
</span></span></code></pre></div><p>Now when you check che Cluster Console under <em>Administration/Roles</em> and you search for <code>spring</code> you will find the role.</p><p><img src=/static/springboot-configmap/cluster-console-search-spring-roles.png alt=cluster-console-search-spring-roles.png>
<img src=/static/springboot-configmap/cluster-console-spring-roles.png alt=cluster-console-spring-roles.png></p><h2 id=deploy-configmap>Deploy ConfigMap<a class=anchor aria-hidden=true href=#deploy-configmap>#</a></h2><p>Now is time to create our <code>ConfigMap</code> and <code>apply</code> it in the <code>development</code> namespace for the <code>oder-service</code>
You can do it directly in a shell.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ echo <span style=color:#e6db74>&#34;apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>kind: ConfigMap
</span></span></span><span style=display:flex><span><span style=color:#e6db74>metadata:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    #  matches the spring app name as defined in application.yml
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    name: order-service
</span></span></span><span style=display:flex><span><span style=color:#e6db74>data:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    #  must be named &#39;application.yaml&#39; or be the only key in this config
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    #  refer to Spring Cloud Kubernetes Config documentation or source code
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    application.yaml: |
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        opentracing:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            jaeger:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                http-sender:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                    url: http://jaeger-collector-jaeger.apps.c3smonkey.ch/api/traces&#34;</span> | oc apply -f -
</span></span></code></pre></div><p>Better is you create a <code>ConfigMap</code> file and then you use the <code>apply</code> command.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ oc apply -f deployments/configmap.yaml
</span></span></code></pre></div><p>When you hit the service again you will see some traces in the Jaeger now.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ <span style=color:#66d9ef>for</span> x in <span style=color:#f92672>(</span>seq 50<span style=color:#f92672>)</span>; http <span style=color:#e6db74>&#34;http://order-service-development.apps.c3smonkey.ch/api/v1/orders/random&#34;</span>; end
</span></span></code></pre></div><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p><a href=https://www.jaegertracing.io/ target=_blank rel=noopener>jaegertracing.io</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><div class=share-buttons></div></div><aside><article><h3>See Also</h3><a href=/blog/2019/2019-10-22-axon/><hgroup><h4><i>AxonIQ</i></h4><p><time datetime='2019-09-18 00:00:00 +0000 UTC'>September 18, 2019</time>&nbsp;·&nbsp;3 min&nbsp;·&nbsp;Marcel Widmer</p></hgroup></a><a href=/blog/2019/2019-08-28-multiple-project-promoting/><hgroup><h4><i>Promoting Applications Across Environments</i></h4><p><time datetime='2019-09-18 00:00:00 +0000 UTC'>September 18, 2019</time>&nbsp;·&nbsp;8 min&nbsp;·&nbsp;Marcel Widmer</p></hgroup></a><a href=/blog/2019/2019-09-21-spring-boot-k8s-ribbon-discovery/><hgroup><h4><i>Spring Boot Kubernetes Discovery</i></h4><p><time datetime='2019-09-18 00:00:00 +0000 UTC'>September 18, 2019</time>&nbsp;·&nbsp;1 min&nbsp;·&nbsp;Marcel Widmer</p></hgroup></a><a href=/blog/2019/2019-09-08-semantic-release-delivery-pipeline/><hgroup><h4><i>Semantic Release Delivery Pipeline</i></h4><p><time datetime='2019-09-08 00:00:00 +0000 UTC'>September 8, 2019</time>&nbsp;·&nbsp;6 min&nbsp;·&nbsp;Marcel Widmer</p></hgroup></a><a href=/blog/2019/2019-09-01-jaeger/><hgroup><h4><i>Jaeger - Distributed Tracing System</i></h4><p><time datetime='2019-09-01 00:00:00 +0000 UTC'>September 1, 2019</time>&nbsp;·&nbsp;3 min&nbsp;·&nbsp;Marcel Widmer</p></hgroup></a></article></aside></div></div></main><footer class=text-center><span>&copy; 2022 <a href=https://blog.marcelwidmer.org>c3smonkey's blog</a></span><div><a href=https://blog.marcelwidmer.org/legal/privacy>Privacy Policy</a>
<span>&</span>
<a href=https://blog.marcelwidmer.org/legal/terms-and-conditions>Terms and Conditions</a></div></footer><article class=hidden id=cookie-banner><div><span></span></div><footer><a role=button id=consent-cookies>Close</a>
<a role=button class=secondary href=/></a></footer></article><script async src=https://blog.marcelwidmer.org/js/cookie.min.js layout=container></script>
<script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("kbd");t.classList.add("copy-code"),t.innerText="copy";function s(){t.innerText="copied!",setTimeout(()=>{t.innerText="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script><script src=https://blog.marcelwidmer.org/plugins/js/feather.min.js layout=container></script>
<script src=https://blog.marcelwidmer.org/js/script.min.js layout=container></script></body></html>