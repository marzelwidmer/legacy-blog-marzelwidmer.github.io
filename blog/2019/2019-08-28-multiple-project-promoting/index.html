<!doctype html><html lang=en-us><head><meta charset=utf-8><title>Promoting Applications Across Environments | c3smonkey's blog</title><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Create Project We are going to use the CLI to create some projects. Let&rsquo;s create our projects first:
$ oc login $ oc new-project development --display-name=&#34;Development Environment&#34; $ oc new-project testing --display-name=&#34;Testing Environment&#34; $ oc new-project production --display-name=&#34;Production Environment&#34; $ oc new-project jenkins --display-name=&#34;Jenkins CI/CD&#34; Install Jenkins Create a Jenkins in the Jenkins CI/CD project with some storage. Take the Jenkins from the catalog and set some more memory and volume capacity on it."><meta name=author content="Marcel Widmer"><link rel=canonical href=https://blog.marcelwidmer.org/blog/2019/2019-08-28-multiple-project-promoting/><link rel=stylesheet href=https://blog.marcelwidmer.org/sass/main.min.css><link rel=stylesheet href=https://blog.marcelwidmer.org/sass/nav.min.css><link rel=stylesheet href=https://blog.marcelwidmer.org/plugins/css/pico.min.css><script defer crossorigin=anonymous src=/assets/js/highlight.min.b95bacdc39e37a332a9f883b1e78be4abc1fdca2bc1f2641f55e3cd3dabd4d61.js integrity="sha256-uVus3DnjejMqn4g7Hni+Srwf3KK8HyZB9V4809q9TWE=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://blog.marcelwidmer.org/static/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blog.marcelwidmer.org/static/favicon.ico><link rel=icon type=image/png sizes=32x32 href=https://blog.marcelwidmer.org/static/favicon.ico><link rel=apple-touch-icon href=https://blog.marcelwidmer.org/static/favicon.ico><link rel=mask-icon href=https://blog.marcelwidmer.org/static/favicon.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.104.2"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.marcelwidmer.org/static"><meta name=twitter:title content="Promoting Applications Across Environments"><meta name=twitter:description content="Create Project We are going to use the CLI to create some projects. Let&rsquo;s create our projects first:
$ oc login $ oc new-project development --display-name=&#34;Development Environment&#34; $ oc new-project testing --display-name=&#34;Testing Environment&#34; $ oc new-project production --display-name=&#34;Production Environment&#34; $ oc new-project jenkins --display-name=&#34;Jenkins CI/CD&#34; Install Jenkins Create a Jenkins in the Jenkins CI/CD project with some storage. Take the Jenkins from the catalog and set some more memory and volume capacity on it."><meta property="og:title" content="Promoting Applications Across Environments"><meta property="og:description" content="Create Project We are going to use the CLI to create some projects. Let&rsquo;s create our projects first:
$ oc login $ oc new-project development --display-name=&#34;Development Environment&#34; $ oc new-project testing --display-name=&#34;Testing Environment&#34; $ oc new-project production --display-name=&#34;Production Environment&#34; $ oc new-project jenkins --display-name=&#34;Jenkins CI/CD&#34; Install Jenkins Create a Jenkins in the Jenkins CI/CD project with some storage. Take the Jenkins from the catalog and set some more memory and volume capacity on it."><meta property="og:type" content="article"><meta property="og:url" content="https://blog.marcelwidmer.org/blog/2019/2019-08-28-multiple-project-promoting/"><meta property="og:image" content="https://blog.marcelwidmer.org/static"><meta property="article:section" content="blog"><meta property="article:published_time" content="2019-09-18T00:00:00+00:00"><meta property="article:modified_time" content="2019-09-18T00:00:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.marcelwidmer.org/static"><meta name=twitter:title content="Promoting Applications Across Environments"><meta name=twitter:description content="Create Project We are going to use the CLI to create some projects. Let&rsquo;s create our projects first:
$ oc login $ oc new-project development --display-name=&#34;Development Environment&#34; $ oc new-project testing --display-name=&#34;Testing Environment&#34; $ oc new-project production --display-name=&#34;Production Environment&#34; $ oc new-project jenkins --display-name=&#34;Jenkins CI/CD&#34; Install Jenkins Create a Jenkins in the Jenkins CI/CD project with some storage. Take the Jenkins from the catalog and set some more memory and volume capacity on it."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Blog","item":"https://blog.marcelwidmer.org/blog/"},{"@type":"ListItem","position":3,"name":"Promoting Applications Across Environments","item":"https://blog.marcelwidmer.org/blog/2019/2019-08-28-multiple-project-promoting/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Promoting Applications Across Environments","name":"Promoting Applications Across Environments","description":"Create Project We are going to use the CLI to create some projects. Let\u0026rsquo;s create our projects first:\n$ oc login $ oc new-project development --display-name=\u0026#34;Development Environment\u0026#34; $ oc new-project testing --display-name=\u0026#34;Testing Environment\u0026#34; $ oc new-project production --display-name=\u0026#34;Production Environment\u0026#34; $ oc new-project jenkins --display-name=\u0026#34;Jenkins CI/CD\u0026#34; Install Jenkins Create a Jenkins in the Jenkins CI/CD project with some storage. Take the Jenkins from the catalog and set some more memory and volume capacity on it.","keywords":["k8s","CI/CD","Spring Boot"],"articleBody":"Create Project We are going to use the CLI to create some projects. Let‚Äôs create our projects first:\n$ oc login $ oc new-project development --display-name=\"Development Environment\" $ oc new-project testing --display-name=\"Testing Environment\" $ oc new-project production --display-name=\"Production Environment\" $ oc new-project jenkins --display-name=\"Jenkins CI/CD\" Install Jenkins Create a Jenkins in the Jenkins CI/CD project with some storage. Take the Jenkins from the catalog and set some more memory and volume capacity on it. Everything else we let the default values. Login with your Openshift account to the Jenkins BlueOcean.\nConfigure Jenkins Maven Slave - Concurrency Limit Let‚Äôs configure out Maven-Slave concurrency limit to 5 in order that we later want build more then one project. Please go to the Jenkins Configuration Page https:///configure in the section Cloud/Kubernetes Pod Template and search for the Maven Pod.\nInstall Jenkins with CLI $ oc new-app jenkins-persistent --name jenkins --param ENABLE_OAUTH=true \\ --param MEMORY_LIMIT=2Gi --param VOLUME_CAPACITY=4Gi -n jenkins Jenkins File From Source Repository The pipeline Jenkinsfile is provided in the source repository.\nAdd Edit Role To ServiceAccount Jenkins Let‚Äôs add in RBAC to our projects to allow the different service accounts to build, pro‚Äê mote, and tag images. First we will allow the cicd project‚Äôs Jenkins service account edit access to all of our projects:\n$ oc policy add-role-to-user edit system:serviceaccount:jenkins:jenkins -n development $ oc policy add-role-to-user edit system:serviceaccount:jenkins:jenkins -n testing $ oc policy add-role-to-user edit system:serviceaccount:jenkins:jenkins -n production Add Role To Group That we can pull our image from testing and production environment from the development registry. This is needed for pulling the Images across the projects.\n$ oc policy add-role-to-group system:image-puller system:serviceaccounts:testing \\ -n development $ oc policy add-role-to-group system:image-puller system:serviceaccounts:production \\ -n development Deploy Application Let‚Äôs deploy first the application with the S2i strategy. before we will create the delivery pipeline.\nDevelopment Environment Deployment Let‚Äôs change first the project to to development with the oc project development command.\n$ oc project development Now using project \"development\" on server \"https://console.c3smonkey.ch:8443\". Creat a new app with `oc new-app` We will use here the fabric8/s2i-java to deploy our application and will point it to the master branch with the command oc new-app We also want expose the service oc expose svc/catalog-service to get a URL with the command oc get route catalog-service we will see the URL on the terminal.\n$ oc new-app fabric8/s2i-java:latest-java11~https://github.com/marzelwidmer/catalog-service.git#master; \\ oc expose svc/catalog-service; \\ oc get route catalog-service --\u003e Found Docker image 6414174 (7 weeks old) from Docker Hub for \"fabric8/s2i-java:latest-java11\" Java Applications ----------------- Platform for building and running plain Java applications (fat-jar and flat classpath) Tags: builder, java * An image stream tag will be created as \"s2i-java:latest-java11\" that will track the source image * A source build using source code from https://github.com/marzelwidmer/catalog-service.git#master will be created * The resulting image will be pushed to image stream tag \"catalog-service:latest\" * Every time \"s2i-java:latest-java11\" changes a new build will be triggered * This image will be deployed in deployment config \"catalog-service\" * Ports 8080/tcp, 8778/tcp, 9779/tcp will be load balanced by service \"catalog-service\" * Other containers can access this service through the hostname \"catalog-service\" --\u003e Creating resources ... imagestream.image.openshift.io \"s2i-java\" created imagestream.image.openshift.io \"catalog-service\" created buildconfig.build.openshift.io \"catalog-service\" created deploymentconfig.apps.openshift.io \"catalog-service\" created service \"catalog-service\" created --\u003e Success Build scheduled, use 'oc logs -f bc/catalog-service' to track its progress. Application is not exposed. You can expose services to the outside world by executing one or more of the commands below: 'oc expose svc/catalog-service' Run 'oc status' to view your app. route.route.openshift.io/catalog-service exposed NAME HOST/PORT PATH SERVICES PORT TERMINATION WILDCARD catalog-service catalog-service-development.apps.c3smonkey.ch catalog-service 8080-tcp None Now take a look in the OpenShift Console project development\nLet‚Äôs take a look what the S2i crated for us. This can be done with the following command oc get all -n development --selector app=catalog-service.\n$ oc get all -n development --selector app=catalog-service NAME READY STATUS RESTARTS AGE pod/catalog-service-1-2rv5r 1/1 Running 0 56m NAME DESIRED CURRENT READY AGE replicationcontroller/catalog-service-1 1 1 1 56m NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE service/catalog-service ClusterIP 172.30.216.240 8080/TCP,8778/TCP,9779/TCP 57m NAME REVISION DESIRED CURRENT TRIGGERED BY deploymentconfig.apps.openshift.io/catalog-service 1 1 1 config,image(catalog-service:latest) NAME TYPE FROM LATEST buildconfig.build.openshift.io/catalog-service Source Git@master 1 NAME TYPE FROM STATUS STARTED DURATION build.build.openshift.io/catalog-service-1 Source Git@b49dff4 Complete About an hour ago 1m10s NAME DOCKER REPO TAGS imagestream.image.openshift.io/catalog-service docker-registry.default.svc:5000/development/catalog-service latest imagestream.image.openshift.io/s2i-java docker-registry.default.svc:5000/development/s2i-java latest-java11 NAME HOST/PORT PATH SERVICES PORT WILDCARD route.route.openshift.io/catalog-service catalog-service-development.apps.c3smonkey.ch catalog-service 8080-tcp None Test API on Development Now let‚Äôs test the amazing /api/v1/animals/rando API from catalog-service by hitting the following Rest endpoint 50 times. in a bash shell with the following command. for x in (seq 50); http \"http://catalog-service-development.apps.c3smonkey.ch/api/v1/animals/random\"; end\n$ ~ üê† for x in (seq 50); \\ http \"http://catalog-service-development.apps.c3smonkey.ch/api/v1/animals/random\"; \\ end HTTP/1.1 200 OK Cache-control: private Content-Length: 14 Content-Type: text/plain;charset=UTF-8 Set-Cookie: 1e5e1500c4996e7978ef9efb67d863a1=1e12d12873c24c5c17782f3da537ed6a; path=/; HttpOnly Burrowing Frog HTTP/1.1 200 OK Cache-control: private Content-Length: 14 Content-Type: text/plain;charset=UTF-8 Set-Cookie: 1e5e1500c4996e7978ef9efb67d863a1=1e12d12873c24c5c17782f3da537ed6a; path=/; HttpOnly Dogo Argentino HTTP/1.1 200 OK Testing Environment Deployment Let‚Äôs change first to the testing project with oc project testing. We remember that we have in our setup only one docker registry from this registry we want promote our Docker images to other projects in our OpenShift Cluster setup. The access is now available because we did the Add Role To Group. Now let‚Äôs take a look at the ImageStream in the project development with the following command oc get is -n development we will get the docker registry we need to create the a deployment configuration in the project testing. We are searching for the catalog-service docker registry.\n$ oc get is -n development NAME DOCKER REPO TAGS UPDATED catalog-service docker-registry.default.svc:5000/development/catalog-service latest About an hour ago s2i-java docker-registry.default.svc:5000/development/s2i-java latest-java11 About an hour ago Now let‚Äôs create a deployment configuration for the promoteQA tag with oc create dc catalog-service --image=docker-registry.default.svc:5000/development/catalog-service:promoteQA Our Jenkins pipeline is configured to interact with this tag to promote between the environments.\n$ oc create dc catalog-service --image=docker-registry.default.svc:5000/development/catalog-service:promoteQA deploymentconfig.apps.openshift.io/catalog-service created Now we have to expose the dc/catalog-service with the port 8080 who our Spring Boot App is running on.\nThis easy done with the oc expose dc catalog-service --port=8080 command.\n$ oc expose dc catalog-service --port=8080 service/catalog-service exposed Now also expose the service and get the route oc expose service catalog-service --name=catalog-service; oc get route\n$ oc expose service catalog-service --name=catalog-service; oc get route route.route.openshift.io/catalog-service exposed NAME HOST/PORT PATH SERVICES PORT TERMINATION WILDCARD catalog-service catalog-service-testing.apps.c3smonkey.ch catalog-service 8080 None We have to patch the dc imagePullPolicy from IfNotPresent to Always with oc patch command. The default is set to IfNotPresent, but we wish to always trigger a deployment when we tag a new image\n$ oc patch dc/catalog-service -p \\ '{\"spec\":{\"template\":{\"spec\":{\"containers\":[{\"name\":\"default-container\",\"imagePullPolicy\":\"Always\"}]}}}}' Production Environment Deployment The same what we did on the Testing Environment Deployment we also do now on the production environment. But we configure the promotion tag promotePRD in the deployment configuration.\n$ oc project production $ oc create dc catalog-service --image=docker-registry.default.svc:5000/development/catalog-service:promotePRD $ oc patch dc/catalog-service -p \\ '{\"spec\":{\"template\":{\"spec\":{\"containers\":[{\"name\":\"default-container\",\"imagePullPolicy\":\"Always\"}]}}}}' $ oc expose dc catalog-service --port=8080 $ oc expose svc/catalog-service Jenkins Pipeline So now let‚Äôs create a BuildConfig for the catalaog-service with the following catalog-service-jenkins-pipeline configuration in the Jenkins namespace (project) let‚Äôs do it with oc create -n jenkins -f https://blog.marcelwidmer.org/openshift-pipeline/catalog-service-pipeline.yaml\n$ oc create -n jenkins -f \\ https://blog.marcelwidmer.org/openshift-pipeline/catalog-service-pipeline.yaml buildconfig.build.openshift.io/catalog-service-pipeline created When you go now in the OpenShift Console in the project Jenkins in the section. Builds/Pipelines you will something like this. Run Jenkins Pipeline Now is time to run the pipeline with the command oc start-build catalog-service-pipeline -n jenkins\n$ oc start-build catalog-service-pipeline -n jenkins build.build.openshift.io/catalog-service-pipeline-1 started After a while you will see something like this. For production deployment we configured our pipeline with a approvable step.\nNow is time to approve the application and hit the After the approve button in the pipeline to deploy to the production namespace.\nWebHooks Now let‚Äôs creat a WebHook. So when we push something in our catalog-service the pipeline start run. Change first to the jenkins project again with oc project jenkins\n$ oc project jenkins Now using project \"jenkins\" on server \"https://console.c3smonkey.ch:8443\" Now check the Buildconfig with oc describe bc/catalog-service-pipeline\n$ oc describe bc/catalog-service-pipeline Name:\tcatalog-service-pipeline Namespace:\tjenkins Created:\t2 hours ago Labels:\tapp=catalog-service-pipeline name=catalog-service-pipeline Annotations:\tLatest Version:\t1 Strategy:\tJenkinsPipeline URL:\thttps://github.com/marzelwidmer/catalog-service.git Ref:\tmaster Jenkinsfile path:\tJenkinsfile Build Run Policy:\tSerial Triggered by:\tBuilds History Limit: Successful:\t5 Failed:\t5 Build\tStatus\tDuration\tCreation Time catalog-service-pipeline-1 complete 8m12s 2019-09-05 13:54:18 +0200 CEST Events:\tAt the moment we don‚Äôt have any GitHub Hooks configured.\nBuildConfig Triggers With the following command you can set GitHub WebHook trigger. This will create a secret for us and configured a WebHook in our BuildConfig.\n$ oc set triggers bc/catalog-service-pipeline --from-github When we run again the oc describe bc/catalog-service-pipeline command we will see that we have a bc like below.\n$ oc describe bc/catalog-service-pipeline Name:\tcatalog-service-pipeline Namespace:\tjenkins Created:\t2 hours ago Labels:\tapp=catalog-service-pipeline name=catalog-service-pipeline Annotations:\tLatest Version:\t1 Strategy:\tJenkinsPipeline URL:\thttps://github.com/marzelwidmer/catalog-service.git Ref:\tmaster Jenkinsfile path:\tJenkinsfile Build Run Policy:\tSerial Triggered by:\tWebhook GitHub: URL:\thttps://okd.ch/apis/build.openshift.io/v1/namespaces/jenkins/buildconfigs/catalog-service-pipeline/webhooks//github Builds History Limit: Successful:\t5 Failed:\t5 Build\tStatus\tDuration\tCreation Time catalog-service-pipeline-1 complete 8m12s 2019-09-05 13:54:18 +0200 CEST Events:\tNote: The URL we will replace with a secret. This is just an place holder in the URL. https://console.c3smonkey.ch:8443/apis/build.openshift.io/v1/namespaces/jenkins/buildconfigs/catalog-service-pipeline/webhooks//github\nTo grab the we have to replace in the URL you can call the following command.\n$ oc get bc/catalog-service-pipeline -o json | jq '.spec.triggers[].github.secret' In your GitHub repository, select Add Webhook from Settings ‚Üí Webhooks. Paste the URL output (similar to above) into the Payload URL field.\nHint: SSL Disable (not recommended) if your cluster don‚Äôt have a valid SSL certificate. SSL verification By default, we verify SSL certificates when delivering payloads.\nReferences:\nhttps://blog.openshift.com/decrease-maven-build-times-openshift-pipelines-using-persistent-volume-claim/ https://github.com/redhat-cop/container-pipelines/tree/master/basic-spring-boot\n","wordCount":"1605","inLanguage":"en","datePublished":"2019-09-18T00:00:00Z","dateModified":"2019-09-18T00:00:00Z","author":{"@type":"Person","name":"Marcel Widmer"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.marcelwidmer.org/blog/2019/2019-08-28-multiple-project-promoting/"},"publisher":{"@type":"Organization","name":"c3smonkey's blog","logo":{"@type":"ImageObject","url":"https://blog.marcelwidmer.org/static/favicon.ico"}}}</script></head><body><nav class=desktop><ul><li><a class=logo href=https://blog.marcelwidmer.org accesskey=h title="Welcome to my blog (Alt + h)"><img src=/static/favicon.ico alt="Welcome to my blog" width=35 height=35></img><h3 style=margin-bottom:0><strong><em>c3smonkey&rsquo;s blog</em></strong></h3></a></li><li class=toggle-container><input type=checkbox id=switch>
<label for=switch><i id=darkIcon data-feather=moon></i>
<i id=lightIcon data-feather=sun></i></label></li></ul><ul class=desktop-navigation><li><a href=/blog title=Blog><i data-feather=pen-tool></i>
<span>Blog</span></a></li><li><a href=/search title="Search (Alt + /)" accesskey=/><i data-feather=search></i>
<span>Search</span></a></li><li><a href=/contact title=Contact><i data-feather=mail></i>
<span>Contact</span></a></li><li><a href=https://github.com/marzelwidmer title=Github><i data-feather=github></i>
<span></span></a></li></ul><ul class=mobile-navigation><li><button id=menuOpen onclick=openMobile() aria-label="Menu closed">
<i data-feather=menu></i></button>
<button id=menuClose onclick=openMobile() aria-label="Menu opened">
<i data-feather=x></i></button></li></ul></nav><aside class=sidebar id=mobileNav style=display:none><nav><ul><li><a href=/blog title=Blog><span><i data-feather=pen-tool></i>
Blog</span></a></li><li><a href=/search title="Search (Alt + /)" accesskey=/><span><i data-feather=search></i>
Search</span></a></li><li><a href=/contact title=Contact><span><i data-feather=mail></i>
Contact</span></a></li><li><a href=https://github.com/marzelwidmer title=Github><span><i data-feather=github></i></span></a></li></ul></nav></aside><main><div class=container><hgroup><div><a href=https://blog.marcelwidmer.org>Home</a>&nbsp;¬ª&nbsp;<a href=https://blog.marcelwidmer.org/blog/>Blog</a></div><h1>Promoting Applications Across Environments</h1><time datetime='2019-09-18 00:00:00 +0000 UTC'>September 18, 2019</time>&nbsp;¬∑&nbsp;8 min&nbsp;¬∑&nbsp;Marcel Widmer<p></p></hgroup><a href=https://blog.marcelwidmer.org/tags/k8s/><kbd>k8s</kbd></a>
<a href=https://blog.marcelwidmer.org/tags/ci/cd/><kbd>CI/CD</kbd></a>
<a href=https://blog.marcelwidmer.org/tags/spring-boot/><kbd>Spring Boot</kbd></a><div class="grid grid-main"><div><article class=toc><div><details open><summary accesskey=c title="(Alt + C)"><span>Table of Contents</span></summary><div><ul><ul><li><a href=#CreateProject aria-label="Create Project ">Create Project</a></li><li><a href=#InstallJenkins aria-label="Install Jenkins ">Install Jenkins</a></li><li><a href=#configure-jenkins-maven-slave---concurrency-limit aria-label="Configure Jenkins Maven Slave - Concurrency Limit">Configure Jenkins Maven Slave - Concurrency Limit</a></li><li><a href=#InstallJenkinsWithCLI aria-label="Install Jenkins with CLI">Install Jenkins with CLI</a><ul><li><a href=#jenkins-file-from-source-repository aria-label="Jenkins File From Source Repository">Jenkins File From Source Repository</a></li></ul></li><li><a href=#AddEditRoleToServiceAccountJenkins aria-label="Add Edit Role To ServiceAccount Jenkins ">Add Edit Role To ServiceAccount Jenkins</a></li><li><a href=#AddRoleToGroup aria-label="Add Role To Group ">Add Role To Group</a></li></ul><li><a href=#DeployApplication aria-label="Deploy Application ">Deploy Application</a><ul><li><a href=#DevelopmentEnvironmentDeployment aria-label="Development Environment Deployment ">Development Environment Deployment</a></li><li><a href=#TestAPI aria-label="Test API on Development ">Test API on Development</a></li><li><a href=#TestingEnvironmentDeployment aria-label="Testing Environment Deployment">Testing Environment Deployment</a></li><li><a href=#ProductionEnvironmentDeployment aria-label="Production Environment Deployment">Production Environment Deployment</a></li><li><a href=#JenkinsPipeline aria-label="Jenkins Pipeline ">Jenkins Pipeline</a><ul><li><a href=#run-jenkins-pipeline aria-label="Run Jenkins Pipeline">Run Jenkins Pipeline</a></li></ul></li><li><a href=#WebHooks aria-label="WebHooks ">WebHooks</a></li><li><a href=#buildconfig-triggers aria-label="BuildConfig Triggers">BuildConfig Triggers</a></li></ul></li></ul></div></details></div></article><div class=post><div class=share-buttons></div><h2 id=CreateProject>Create Project <a class=anchor aria-hidden=true href=#CreateProject>#</a></h2><p>We are going to use the CLI to create some projects.
Let&rsquo;s create our projects first:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ oc login  
</span></span><span style=display:flex><span>$ oc new-project development --display-name<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Development Environment&#34;</span>
</span></span><span style=display:flex><span>$ oc new-project testing --display-name<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Testing Environment&#34;</span>    
</span></span><span style=display:flex><span>$ oc new-project production --display-name<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Production Environment&#34;</span>    
</span></span><span style=display:flex><span>$ oc new-project jenkins --display-name<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Jenkins CI/CD&#34;</span>  
</span></span></code></pre></div><h2 id=InstallJenkins>Install Jenkins <a class=anchor aria-hidden=true href=#InstallJenkins>#</a></h2><p>Create a Jenkins in the <code>Jenkins CI/CD</code> project with some storage. Take the Jenkins from the catalog and set some more memory and volume capacity on it.
Everything else we let the default values.
Login with your Openshift account to the <code>Jenkins BlueOcean</code>.</p><p><img src=/static/multiple-project-promoting/Jenkins-from-catalog-1.png alt=Jenkins-From-Catalog-1>
<img src=/static/multiple-project-promoting/Jenkins-from-catalog-2.png alt=Jenkins-From-Catalog-2>
<img src=/static/multiple-project-promoting/Jenkins-from-catalog-3.png alt=Jenkins-From-Catalog-3></p><h2 id=configure-jenkins-maven-slave---concurrency-limit>Configure Jenkins Maven Slave - Concurrency Limit<a class=anchor aria-hidden=true href=#configure-jenkins-maven-slave---concurrency-limit>#</a></h2><p>Let&rsquo;s configure out <code>Maven-Slave</code> concurrency limit to <code>5</code> in order that we later want build more then one project.
Please go to the Jenkins Configuration Page <code>https://&lt;jenkins>/configure</code> in the section <code>Cloud/Kubernetes Pod Template</code> and search for the <code>Maven</code> Pod.</p><p><img src=/static/multiple-project-promoting/Maven-Pod-Concurrency-Limit.png alt=Maven-Pod-Concurrency-Limit></p><h2 id=InstallJenkinsWithCLI>Install Jenkins with CLI<a class=anchor aria-hidden=true href=#InstallJenkinsWithCLI>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ oc new-app jenkins-persistent --name jenkins --param ENABLE_OAUTH<span style=color:#f92672>=</span>true <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        --param MEMORY_LIMIT<span style=color:#f92672>=</span>2Gi --param VOLUME_CAPACITY<span style=color:#f92672>=</span>4Gi -n jenkins
</span></span></code></pre></div><h3 id=jenkins-file-from-source-repository>Jenkins File From Source Repository<a class=anchor aria-hidden=true href=#jenkins-file-from-source-repository>#</a></h3><p>The pipeline <a href=https://raw.githubusercontent.com/marzelwidmer/marzelwidmer.github.io/master/img/2019/multiple-project-promoting/Promotion-Jenkinsfile target=_blank rel=noopener>Jenkinsfile</a> is provided in the source repository.</p><h2 id=AddEditRoleToServiceAccountJenkins>Add Edit Role To ServiceAccount Jenkins <a class=anchor aria-hidden=true href=#AddEditRoleToServiceAccountJenkins>#</a></h2><p>Let‚Äôs add in RBAC to our projects to allow the different service accounts to build, pro‚Äê mote, and tag images.
First we will allow the cicd project‚Äôs Jenkins service account edit access to all of our projects:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ oc policy add-role-to-user edit system:serviceaccount:jenkins:jenkins -n development
</span></span><span style=display:flex><span>$ oc policy add-role-to-user edit system:serviceaccount:jenkins:jenkins -n testing
</span></span><span style=display:flex><span>$ oc policy add-role-to-user edit system:serviceaccount:jenkins:jenkins -n production
</span></span></code></pre></div><h2 id=AddRoleToGroup>Add Role To Group <a class=anchor aria-hidden=true href=#AddRoleToGroup>#</a></h2><p>That we can pull our image from <code>testing</code> and <code>production</code> environment from the <code>development</code> registry. This is needed for pulling the Images across the projects.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ oc policy add-role-to-group system:image-puller system:serviceaccounts:testing  <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        -n development
</span></span><span style=display:flex><span>$ oc policy add-role-to-group system:image-puller system:serviceaccounts:production <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        -n development
</span></span></code></pre></div><h1 id=DeployApplication>Deploy Application <a class=anchor aria-hidden=true href=#DeployApplication>#</a></h1><p>Let&rsquo;s deploy first the application with the <a href=https://docs.openshift.com/container-platform/3.11/creating_images/s2i.html target=_blank rel=noopener>S2i strategy</a>.
before we will create the delivery pipeline.</p><h2 id=DevelopmentEnvironmentDeployment>Development Environment Deployment <a class=anchor aria-hidden=true href=#DevelopmentEnvironmentDeployment>#</a></h2><p>Let&rsquo;s change first the project to to development with the <code>oc project development</code> command.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ oc project development
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Now using project <span style=color:#e6db74>&#34;development&#34;</span> on server <span style=color:#e6db74>&#34;https://console.c3smonkey.ch:8443&#34;</span>.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Creat a new app with <span style=color:#e6db74>`</span>oc new-app<span style=color:#e6db74>`</span>
</span></span></code></pre></div><p>We will use here the <a href=https://hub.docker.com/r/fabric8/s2i-java target=_blank rel=noopener>fabric8/s2i-java</a> to deploy our application and will point it to the master branch with the command <code>oc new-app</code>
We also want expose the service <code>oc expose svc/catalog-service</code> to get a URL with the command <code>oc get route catalog-service</code> we will see the URL on the terminal.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ oc new-app fabric8/s2i-java:latest-java11~https://github.com/marzelwidmer/catalog-service.git#master; <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    oc expose svc/catalog-service; <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    oc get route catalog-service
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>--&gt; Found Docker image <span style=color:#ae81ff>6414174</span> <span style=color:#f92672>(</span><span style=color:#ae81ff>7</span> weeks old<span style=color:#f92672>)</span> from Docker Hub <span style=color:#66d9ef>for</span> <span style=color:#e6db74>&#34;fabric8/s2i-java:latest-java11&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  Java Applications
</span></span><span style=display:flex><span>  -----------------
</span></span><span style=display:flex><span>  Platform <span style=color:#66d9ef>for</span> building and running plain Java applications <span style=color:#f92672>(</span>fat-jar and flat classpath<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  Tags: builder, java
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  * An image stream tag will be created as <span style=color:#e6db74>&#34;s2i-java:latest-java11&#34;</span> that will track the source image
</span></span><span style=display:flex><span>  * A source build using source code from https://github.com/marzelwidmer/catalog-service.git#master will be created
</span></span><span style=display:flex><span>    * The resulting image will be pushed to image stream tag <span style=color:#e6db74>&#34;catalog-service:latest&#34;</span>
</span></span><span style=display:flex><span>    * Every time <span style=color:#e6db74>&#34;s2i-java:latest-java11&#34;</span> changes a new build will be triggered
</span></span><span style=display:flex><span>  * This image will be deployed in deployment config <span style=color:#e6db74>&#34;catalog-service&#34;</span>
</span></span><span style=display:flex><span>  * Ports 8080/tcp, 8778/tcp, 9779/tcp will be load balanced by service <span style=color:#e6db74>&#34;catalog-service&#34;</span>
</span></span><span style=display:flex><span>    * Other containers can access this service through the hostname <span style=color:#e6db74>&#34;catalog-service&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>--&gt; Creating resources ...
</span></span><span style=display:flex><span>    imagestream.image.openshift.io <span style=color:#e6db74>&#34;s2i-java&#34;</span> created
</span></span><span style=display:flex><span>    imagestream.image.openshift.io <span style=color:#e6db74>&#34;catalog-service&#34;</span> created
</span></span><span style=display:flex><span>    buildconfig.build.openshift.io <span style=color:#e6db74>&#34;catalog-service&#34;</span> created
</span></span><span style=display:flex><span>    deploymentconfig.apps.openshift.io <span style=color:#e6db74>&#34;catalog-service&#34;</span> created
</span></span><span style=display:flex><span>    service <span style=color:#e6db74>&#34;catalog-service&#34;</span> created
</span></span><span style=display:flex><span>--&gt; Success
</span></span><span style=display:flex><span>    Build scheduled, use <span style=color:#e6db74>&#39;oc logs -f bc/catalog-service&#39;</span> to track its progress.
</span></span><span style=display:flex><span>    Application is not exposed. You can expose services to the outside world by executing one or more of the commands below:
</span></span><span style=display:flex><span>     <span style=color:#e6db74>&#39;oc expose svc/catalog-service&#39;</span>
</span></span><span style=display:flex><span>    Run <span style=color:#e6db74>&#39;oc status&#39;</span> to view your app.
</span></span><span style=display:flex><span>route.route.openshift.io/catalog-service exposed
</span></span><span style=display:flex><span>NAME             HOST/PORT                                      PATH  SERVICES         PORT      TERMINATION  WILDCARD
</span></span><span style=display:flex><span>catalog-service  catalog-service-development.apps.c3smonkey.ch        catalog-service  8080-tcp               None
</span></span></code></pre></div><p>Now take a look in the OpenShift Console project <code>development</code></p><p><img src=/static/multiple-project-promoting/catalog-service-dev-deployment.png alt=catalog-service-dev-deployment></p><p>Let&rsquo;s take a look what the S2i crated for us.
This can be done with the following command <code>oc get all -n development --selector app=catalog-service</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ oc get all -n development --selector app<span style=color:#f92672>=</span>catalog-service                                  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>NAME                          READY   STATUS    RESTARTS   AGE
</span></span><span style=display:flex><span>pod/catalog-service-1-2rv5r   1/1     Running   <span style=color:#ae81ff>0</span>          56m
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>NAME                                      DESIRED   CURRENT   READY   AGE
</span></span><span style=display:flex><span>replicationcontroller/catalog-service-1   <span style=color:#ae81ff>1</span>         <span style=color:#ae81ff>1</span>         <span style=color:#ae81ff>1</span>       56m
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>NAME                      TYPE        CLUSTER-IP       EXTERNAL-IP   PORT<span style=color:#f92672>(</span>S<span style=color:#f92672>)</span>                      AGE
</span></span><span style=display:flex><span>service/catalog-service   ClusterIP   172.30.216.240   &lt;none&gt;        8080/TCP,8778/TCP,9779/TCP   57m
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>NAME                                                 REVISION   DESIRED   CURRENT   TRIGGERED BY
</span></span><span style=display:flex><span>deploymentconfig.apps.openshift.io/catalog-service   <span style=color:#ae81ff>1</span>          <span style=color:#ae81ff>1</span>         <span style=color:#ae81ff>1</span>         config,image<span style=color:#f92672>(</span>catalog-service:latest<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>NAME                                             TYPE     FROM         LATEST
</span></span><span style=display:flex><span>buildconfig.build.openshift.io/catalog-service   Source   Git@master   <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>NAME                                         TYPE     FROM          STATUS     STARTED             DURATION
</span></span><span style=display:flex><span>build.build.openshift.io/catalog-service-1   Source   Git@b49dff4   Complete   About an hour ago   1m10s
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>NAME                                             DOCKER REPO                                                    TAGS            
</span></span><span style=display:flex><span>imagestream.image.openshift.io/catalog-service   docker-registry.default.svc:5000/development/catalog-service   latest           
</span></span><span style=display:flex><span>imagestream.image.openshift.io/s2i-java          docker-registry.default.svc:5000/development/s2i-java          latest-java11   
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>NAME                                       HOST/PORT                                       PATH   SERVICES          PORT        WILDCARD
</span></span><span style=display:flex><span>route.route.openshift.io/catalog-service   catalog-service-development.apps.c3smonkey.ch          catalog-service   8080-tcp    None
</span></span></code></pre></div><h2 id=TestAPI>Test API on Development <a class=anchor aria-hidden=true href=#TestAPI>#</a></h2><p>Now let&rsquo;s test the amazing <code>/api/v1/animals/rando</code> API from <code>catalog-service</code> by hitting the following Rest endpoint 50 times.
in a bash shell with the following command. <code>for x in (seq 50); http "http://catalog-service-development.apps.c3smonkey.ch/api/v1/animals/random"; end</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ~ üê† 
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> x in <span style=color:#f92672>(</span>seq 50<span style=color:#f92672>)</span>; <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>     http <span style=color:#e6db74>&#34;http://catalog-service-development.apps.c3smonkey.ch/api/v1/animals/random&#34;</span>; <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>end                                                                               
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>HTTP/1.1 <span style=color:#ae81ff>200</span> OK
</span></span><span style=display:flex><span>Cache-control: private
</span></span><span style=display:flex><span>Content-Length: <span style=color:#ae81ff>14</span>
</span></span><span style=display:flex><span>Content-Type: text/plain;charset<span style=color:#f92672>=</span>UTF-8
</span></span><span style=display:flex><span>Set-Cookie: 1e5e1500c4996e7978ef9efb67d863a1<span style=color:#f92672>=</span>1e12d12873c24c5c17782f3da537ed6a; path<span style=color:#f92672>=</span>/; HttpOnly
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Burrowing Frog
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>HTTP/1.1 <span style=color:#ae81ff>200</span> OK
</span></span><span style=display:flex><span>Cache-control: private
</span></span><span style=display:flex><span>Content-Length: <span style=color:#ae81ff>14</span>
</span></span><span style=display:flex><span>Content-Type: text/plain;charset<span style=color:#f92672>=</span>UTF-8
</span></span><span style=display:flex><span>Set-Cookie: 1e5e1500c4996e7978ef9efb67d863a1<span style=color:#f92672>=</span>1e12d12873c24c5c17782f3da537ed6a; path<span style=color:#f92672>=</span>/; HttpOnly
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Dogo Argentino
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>HTTP/1.1 <span style=color:#ae81ff>200</span> OK
</span></span></code></pre></div><h2 id=TestingEnvironmentDeployment>Testing Environment Deployment<a class=anchor aria-hidden=true href=#TestingEnvironmentDeployment>#</a></h2><p>Let&rsquo;s change first to the testing project with <code>oc project testing</code>.
We remember that we have in our setup only one docker registry from this registry we want promote our Docker images to other projects in our OpenShift Cluster setup.
The access is now available because we did the <a href=#AddRoleToGroup>Add Role To Group</a>. Now let&rsquo;s take a look at the ImageStream in the project <code>development</code> with the
following command <code>oc get is -n development</code> we will get the docker registry we need to create the a deployment configuration in the project <code>testing</code>. We are searching for the
<code>catalog-service</code> docker registry.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ oc get is -n development
</span></span><span style=display:flex><span>NAME              DOCKER REPO                                                    TAGS            UPDATED
</span></span><span style=display:flex><span>catalog-service   docker-registry.default.svc:5000/development/catalog-service   latest          About an hour ago
</span></span><span style=display:flex><span>s2i-java          docker-registry.default.svc:5000/development/s2i-java          latest-java11   About an hour ago
</span></span></code></pre></div><p>Now let&rsquo;s create a deployment configuration for the <code>promoteQA</code> tag with <code>oc create dc catalog-service --image=docker-registry.default.svc:5000/development/catalog-service:promoteQA</code>
Our Jenkins pipeline is configured to interact with this tag to promote between the environments.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ oc create dc catalog-service --image<span style=color:#f92672>=</span>docker-registry.default.svc:5000/development/catalog-service:promoteQA
</span></span><span style=display:flex><span>deploymentconfig.apps.openshift.io/catalog-service created
</span></span></code></pre></div><p>Now we have to expose the <code>dc/catalog-service</code> with the port <code>8080</code> who our Spring Boot App is running on.<br>This easy done with the <code>oc expose dc catalog-service --port=8080</code> command.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ oc expose dc catalog-service --port<span style=color:#f92672>=</span><span style=color:#ae81ff>8080</span>
</span></span><span style=display:flex><span>service/catalog-service exposed
</span></span></code></pre></div><p>Now also expose the service and get the route <code>oc expose service catalog-service --name=catalog-service; oc get route</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ oc expose service catalog-service --name<span style=color:#f92672>=</span>catalog-service; oc get route
</span></span><span style=display:flex><span>route.route.openshift.io/catalog-service exposed
</span></span><span style=display:flex><span>NAME              HOST/PORT                                   PATH   SERVICES          PORT   TERMINATION   WILDCARD
</span></span><span style=display:flex><span>catalog-service   catalog-service-testing.apps.c3smonkey.ch          catalog-service   <span style=color:#ae81ff>8080</span>                 None
</span></span></code></pre></div><p>We have to patch the <code>dc</code> <code>imagePullPolicy</code> from <code>IfNotPresent</code> to <code>Always</code> with <code>oc patch</code> command. The default is set to <code>IfNotPresent</code>,
but we wish to always trigger a deployment when we tag a new image</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ oc patch dc/catalog-service  -p <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>      <span style=color:#e6db74>&#39;{&#34;spec&#34;:{&#34;template&#34;:{&#34;spec&#34;:{&#34;containers&#34;:[{&#34;name&#34;:&#34;default-container&#34;,&#34;imagePullPolicy&#34;:&#34;Always&#34;}]}}}}&#39;</span>
</span></span></code></pre></div><h2 id=ProductionEnvironmentDeployment>Production Environment Deployment<a class=anchor aria-hidden=true href=#ProductionEnvironmentDeployment>#</a></h2><p>The same what we did on the <a href=#TestingEnvironmentDeployment>Testing Environment Deployment</a> we also do now on the production environment.
But we configure the promotion tag <code>promotePRD</code> in the deployment configuration.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ oc project production
</span></span><span style=display:flex><span>$ oc create dc catalog-service --image<span style=color:#f92672>=</span>docker-registry.default.svc:5000/development/catalog-service:promotePRD
</span></span><span style=display:flex><span>$ oc patch dc/catalog-service  -p <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>     <span style=color:#e6db74>&#39;{&#34;spec&#34;:{&#34;template&#34;:{&#34;spec&#34;:{&#34;containers&#34;:[{&#34;name&#34;:&#34;default-container&#34;,&#34;imagePullPolicy&#34;:&#34;Always&#34;}]}}}}&#39;</span>
</span></span><span style=display:flex><span>$ oc expose dc catalog-service --port<span style=color:#f92672>=</span><span style=color:#ae81ff>8080</span>
</span></span><span style=display:flex><span>$ oc expose svc/catalog-service
</span></span></code></pre></div><h2 id=JenkinsPipeline>Jenkins Pipeline <a class=anchor aria-hidden=true href=#JenkinsPipeline>#</a></h2><p>So now let&rsquo;s create a <code>BuildConfig</code> for the <code>catalaog-service</code> with the
following <a href=/multiple-project-promoting/catalog-service-pipeline.yaml>catalog-service-jenkins-pipeline</a> configuration
in the Jenkins namespace (project) let&rsquo;s do it with <code>oc create -n jenkins -f https://blog.marcelwidmer.org/openshift-pipeline/catalog-service-pipeline.yaml</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ oc create -n jenkins -f <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    https://blog.marcelwidmer.org/openshift-pipeline/catalog-service-pipeline.yaml
</span></span><span style=display:flex><span>buildconfig.build.openshift.io/catalog-service-pipeline created
</span></span></code></pre></div><p>When you go now in the OpenShift <a href=https://console.c3smonkey.ch:8443/console/project/jenkins/browse/pipelines target=_blank rel=noopener>Console</a> in the project <code>Jenkins</code> in the section.
<code>Builds/Pipelines</code> you will something like this.
<img src=/static/multiple-project-promoting/catalog-service-pipeline-created.png alt="Catalog Service Pipeline"></p><h3 id=run-jenkins-pipeline>Run Jenkins Pipeline<a class=anchor aria-hidden=true href=#run-jenkins-pipeline>#</a></h3><p>Now is time to run the pipeline with the command <code>oc start-build catalog-service-pipeline -n jenkins</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ oc start-build catalog-service-pipeline -n jenkins
</span></span><span style=display:flex><span>build.build.openshift.io/catalog-service-pipeline-1 started
</span></span></code></pre></div><p>After a while you will see something like this. For production deployment we configured our pipeline with a approvable step.</p><p><img src=/static/multiple-project-promoting/catalog-service-pipeline-approvable.png alt="Catalog Service Pipeline approvable"></p><p>Now is time to approve the application and hit the
After the approve button in the pipeline to deploy to the production namespace.</p><p><img src=/static/multiple-project-promoting/catalog-service-pipeline-success.png alt="Catalog Service Pipeline success"></p><h2 id=WebHooks>WebHooks <a class=anchor aria-hidden=true href=#WebHooks>#</a></h2><p>Now let&rsquo;s creat a WebHook. So when we push something in our <code>catalog-service</code> the pipeline start run.
Change first to the <code>jenkins</code> project again with <code>oc project jenkins</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ oc project jenkins
</span></span><span style=display:flex><span>Now using project <span style=color:#e6db74>&#34;jenkins&#34;</span> on server <span style=color:#e6db74>&#34;https://console.c3smonkey.ch:8443&#34;</span>
</span></span></code></pre></div><p>Now check the <code>Buildconfig</code> with <code>oc describe bc/catalog-service-pipeline</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ oc describe bc/catalog-service-pipeline                                                                                                                                               
</span></span><span style=display:flex><span>Name:		catalog-service-pipeline
</span></span><span style=display:flex><span>Namespace:	jenkins
</span></span><span style=display:flex><span>Created:	<span style=color:#ae81ff>2</span> hours ago
</span></span><span style=display:flex><span>Labels:		app<span style=color:#f92672>=</span>catalog-service-pipeline
</span></span><span style=display:flex><span>		name<span style=color:#f92672>=</span>catalog-service-pipeline
</span></span><span style=display:flex><span>Annotations:	&lt;none&gt;
</span></span><span style=display:flex><span>Latest Version:	<span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Strategy:		JenkinsPipeline
</span></span><span style=display:flex><span>URL:			https://github.com/marzelwidmer/catalog-service.git
</span></span><span style=display:flex><span>Ref:			master
</span></span><span style=display:flex><span>Jenkinsfile path:	Jenkinsfile
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Build Run Policy:	Serial
</span></span><span style=display:flex><span>Triggered by:		&lt;none&gt;
</span></span><span style=display:flex><span>Builds History Limit:
</span></span><span style=display:flex><span>	Successful:	<span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>	Failed:		<span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Build				Status		Duration	Creation Time
</span></span><span style=display:flex><span>catalog-service-pipeline-1 	complete 	8m12s 		2019-09-05 13:54:18 +0200 CEST
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Events:	&lt;none&gt;
</span></span></code></pre></div><p>At the moment we don&rsquo;t have any GitHub Hooks configured.</p><h2 id=buildconfig-triggers>BuildConfig Triggers<a class=anchor aria-hidden=true href=#buildconfig-triggers>#</a></h2><p>With the following command you can set GitHub WebHook trigger. This will create a secret for us and configured a WebHook in our BuildConfig.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ oc set triggers bc/catalog-service-pipeline --from-github 
</span></span></code></pre></div><p>When we run again the <code>oc describe bc/catalog-service-pipeline</code> command we will see that we have a <code>bc</code> like below.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ oc describe bc/catalog-service-pipeline                                                                                                                                             
</span></span><span style=display:flex><span>Name:		catalog-service-pipeline
</span></span><span style=display:flex><span>Namespace:	jenkins
</span></span><span style=display:flex><span>Created:	<span style=color:#ae81ff>2</span> hours ago
</span></span><span style=display:flex><span>Labels:		app<span style=color:#f92672>=</span>catalog-service-pipeline
</span></span><span style=display:flex><span>		name<span style=color:#f92672>=</span>catalog-service-pipeline
</span></span><span style=display:flex><span>Annotations:	&lt;none&gt;
</span></span><span style=display:flex><span>Latest Version:	<span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Strategy:		JenkinsPipeline
</span></span><span style=display:flex><span>URL:			https://github.com/marzelwidmer/catalog-service.git
</span></span><span style=display:flex><span>Ref:			master
</span></span><span style=display:flex><span>Jenkinsfile path:	Jenkinsfile
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Build Run Policy:	Serial
</span></span><span style=display:flex><span>Triggered by:		&lt;none&gt;
</span></span><span style=display:flex><span>Webhook GitHub:
</span></span><span style=display:flex><span>	URL:	https://okd.ch/apis/build.openshift.io/v1/namespaces/jenkins/buildconfigs/catalog-service-pipeline/webhooks/&lt;secret&gt;/github
</span></span><span style=display:flex><span>Builds History Limit:
</span></span><span style=display:flex><span>	Successful:	<span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>	Failed:		<span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Build				Status		Duration	Creation Time
</span></span><span style=display:flex><span>catalog-service-pipeline-1 	complete 	8m12s 		2019-09-05 13:54:18 +0200 CEST
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Events:	&lt;none&gt;
</span></span></code></pre></div><blockquote><p><strong><em>Note:</em></strong> The URL we will replace with a secret. This is just an place holder in the URL.
<a href=https://console.c3smonkey.ch:8443/apis/build.openshift.io/v1/namespaces/jenkins/buildconfigs/catalog-service-pipeline/webhooks/ target=_blank rel=noopener>https://console.c3smonkey.ch:8443/apis/build.openshift.io/v1/namespaces/jenkins/buildconfigs/catalog-service-pipeline/webhooks/</a>/github</p></blockquote><p>To grab the <code>&lt;secret></code> we have to replace in the URL you can call the following command.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ oc get bc/catalog-service-pipeline -o json | jq <span style=color:#e6db74>&#39;.spec.triggers[].github.secret&#39;</span>
</span></span></code></pre></div><p>In your GitHub repository, select Add Webhook from Settings ‚Üí Webhooks.
Paste the URL output (similar to above) into the Payload URL field.</p><blockquote><p><strong><em>Hint:</em></strong> <code>SSL Disable (not recommended)</code> if your cluster don&rsquo;t have a valid SSL certificate.
SSL verification
By default, we verify SSL certificates when delivering payloads.</p></blockquote><p><img src=/static/multiple-project-promoting/Add-GitHub-WebHook.png alt="Add GitHub WebHook">
<img src=/static/multiple-project-promoting/GitHub-WebHooks.png alt="GitHub WebHooks"></p><blockquote><p><strong><em>References:</em></strong><br><a href=https://blog.openshift.com/decrease-maven-build-times-openshift-pipelines-using-persistent-volume-claim/ target=_blank rel=noopener>https://blog.openshift.com/decrease-maven-build-times-openshift-pipelines-using-persistent-volume-claim/</a>
<a href=https://github.com/redhat-cop/container-pipelines/tree/master/basic-spring-boot target=_blank rel=noopener>https://github.com/redhat-cop/container-pipelines/tree/master/basic-spring-boot</a></p></blockquote></div><div class=share-buttons></div></div><aside><article><h3>See Also</h3><a href=/blog/2019/2019-10-22-axon/><hgroup><h4><i>AxonIQ</i></h4><p><time datetime='2019-09-18 00:00:00 +0000 UTC'>September 18, 2019</time>&nbsp;¬∑&nbsp;3 min&nbsp;¬∑&nbsp;Marcel Widmer</p></hgroup></a><a href=/blog/2019/2019-09-18-spring-boot-k8s-configmap/><hgroup><h4><i>Spring Boot Kubernetes ConfigMap</i></h4><p><time datetime='2019-09-18 00:00:00 +0000 UTC'>September 18, 2019</time>&nbsp;¬∑&nbsp;3 min&nbsp;¬∑&nbsp;Marcel Widmer</p></hgroup></a><a href=/blog/2019/2019-09-21-spring-boot-k8s-ribbon-discovery/><hgroup><h4><i>Spring Boot Kubernetes Discovery</i></h4><p><time datetime='2019-09-18 00:00:00 +0000 UTC'>September 18, 2019</time>&nbsp;¬∑&nbsp;1 min&nbsp;¬∑&nbsp;Marcel Widmer</p></hgroup></a><a href=/blog/2019/2019-09-08-semantic-release-delivery-pipeline/><hgroup><h4><i>Semantic Release Delivery Pipeline</i></h4><p><time datetime='2019-09-08 00:00:00 +0000 UTC'>September 8, 2019</time>&nbsp;¬∑&nbsp;6 min&nbsp;¬∑&nbsp;Marcel Widmer</p></hgroup></a><a href=/blog/2019/2019-09-01-jaeger/><hgroup><h4><i>Jaeger - Distributed Tracing System</i></h4><p><time datetime='2019-09-01 00:00:00 +0000 UTC'>September 1, 2019</time>&nbsp;¬∑&nbsp;3 min&nbsp;¬∑&nbsp;Marcel Widmer</p></hgroup></a></article></aside></div></div></main><footer class=text-center><span>&copy; 2022 <a href=https://blog.marcelwidmer.org>c3smonkey's blog</a></span><div><a href=https://blog.marcelwidmer.org/legal/privacy>Privacy Policy</a>
<span>&</span>
<a href=https://blog.marcelwidmer.org/legal/terms-and-conditions>Terms and Conditions</a></div></footer><article class=hidden id=cookie-banner><div><span>We use cookies to improve your experience on our site and to show you relevant advertising.</span></div><footer><a role=button id=consent-cookies>Close</a>
<a role=button class=secondary href=/legal/privacy/#cookies-and-web-beacons>Cookies Policy</a></footer></article><script async src=https://blog.marcelwidmer.org/js/cookie.min.js layout=container></script>
<script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("kbd");t.classList.add("copy-code"),t.innerText="copy";function s(){t.innerText="copied!",setTimeout(()=>{t.innerText="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script><script src=https://blog.marcelwidmer.org/plugins/js/feather.min.js layout=container></script>
<script src=https://blog.marcelwidmer.org/js/script.min.js layout=container></script></body></html>