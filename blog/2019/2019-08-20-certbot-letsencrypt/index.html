<!doctype html><html lang=en-us><head><meta charset=utf-8><title>Certbot Let`s Encrypt | c3smonkey's blog</title><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Inspiration from [Adding an SSL certificate to OKD - Part 2 of Installation of OKD 3.10 from start to finish]https://www.youtube.com/watch?v=S7HoJ09oYn0&feature=youtu.be){:target=&#34;_blank&#34;}
Check Certificate Let`s check first if there a certificate already for our domain https://crt.sh/?q=c3smonkey.ch
Check EPEL Reposittory Check if the epel.repo is enabled.
$ vi /etc/yum.repos.d/epel.repo [epel] name=Extra Packages for Enterprise Linux 7 - $basearch #baseurl=http://download.fedoraproject.org/pub/epel/7/$basearch metalink=https://mirrors.fedoraproject.org/metalink?repo=epel-7&arch=$basearch failovermethod=priority enabled=0 gpgcheck=1 gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-7 change enabled=0 to enabled=1 and quite and save the file with :qw"><meta name=author content="Marcel Widmer"><link rel=canonical href=https://blog.marcelwidmer.org/blog/2019/2019-08-20-certbot-letsencrypt/><link rel=stylesheet href=https://blog.marcelwidmer.org/sass/main.min.css><link rel=stylesheet href=https://blog.marcelwidmer.org/sass/nav.min.css><link rel=stylesheet href=https://blog.marcelwidmer.org/plugins/css/pico.min.css><script defer crossorigin=anonymous src=/assets/js/highlight.min.b95bacdc39e37a332a9f883b1e78be4abc1fdca2bc1f2641f55e3cd3dabd4d61.js integrity="sha256-uVus3DnjejMqn4g7Hni+Srwf3KK8HyZB9V4809q9TWE=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://blog.marcelwidmer.org/static/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blog.marcelwidmer.org/static/favicon.ico><link rel=icon type=image/png sizes=32x32 href=https://blog.marcelwidmer.org/static/favicon.ico><link rel=apple-touch-icon href=https://blog.marcelwidmer.org/static/favicon.ico><link rel=mask-icon href=https://blog.marcelwidmer.org/static/favicon.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.104.0"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.marcelwidmer.org/static"><meta name=twitter:title content="Certbot Let`s Encrypt"><meta name=twitter:description content="Inspiration from [Adding an SSL certificate to OKD - Part 2 of Installation of OKD 3.10 from start to finish]https://www.youtube.com/watch?v=S7HoJ09oYn0&feature=youtu.be){:target=&#34;_blank&#34;}
Check Certificate Let`s check first if there a certificate already for our domain https://crt.sh/?q=c3smonkey.ch
Check EPEL Reposittory Check if the epel.repo is enabled.
$ vi /etc/yum.repos.d/epel.repo [epel] name=Extra Packages for Enterprise Linux 7 - $basearch #baseurl=http://download.fedoraproject.org/pub/epel/7/$basearch metalink=https://mirrors.fedoraproject.org/metalink?repo=epel-7&arch=$basearch failovermethod=priority enabled=0 gpgcheck=1 gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-7 change enabled=0 to enabled=1 and quite and save the file with :qw"><meta property="og:title" content="Certbot Let`s Encrypt"><meta property="og:description" content="Inspiration from [Adding an SSL certificate to OKD - Part 2 of Installation of OKD 3.10 from start to finish]https://www.youtube.com/watch?v=S7HoJ09oYn0&feature=youtu.be){:target=&#34;_blank&#34;}
Check Certificate Let`s check first if there a certificate already for our domain https://crt.sh/?q=c3smonkey.ch
Check EPEL Reposittory Check if the epel.repo is enabled.
$ vi /etc/yum.repos.d/epel.repo [epel] name=Extra Packages for Enterprise Linux 7 - $basearch #baseurl=http://download.fedoraproject.org/pub/epel/7/$basearch metalink=https://mirrors.fedoraproject.org/metalink?repo=epel-7&arch=$basearch failovermethod=priority enabled=0 gpgcheck=1 gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-7 change enabled=0 to enabled=1 and quite and save the file with :qw"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.marcelwidmer.org/blog/2019/2019-08-20-certbot-letsencrypt/"><meta property="og:image" content="https://blog.marcelwidmer.org/static"><meta property="article:section" content="blog"><meta property="article:published_time" content="2019-01-13T00:00:00+00:00"><meta property="article:modified_time" content="2019-01-13T00:00:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.marcelwidmer.org/static"><meta name=twitter:title content="Certbot Let`s Encrypt"><meta name=twitter:description content="Inspiration from [Adding an SSL certificate to OKD - Part 2 of Installation of OKD 3.10 from start to finish]https://www.youtube.com/watch?v=S7HoJ09oYn0&feature=youtu.be){:target=&#34;_blank&#34;}
Check Certificate Let`s check first if there a certificate already for our domain https://crt.sh/?q=c3smonkey.ch
Check EPEL Reposittory Check if the epel.repo is enabled.
$ vi /etc/yum.repos.d/epel.repo [epel] name=Extra Packages for Enterprise Linux 7 - $basearch #baseurl=http://download.fedoraproject.org/pub/epel/7/$basearch metalink=https://mirrors.fedoraproject.org/metalink?repo=epel-7&arch=$basearch failovermethod=priority enabled=0 gpgcheck=1 gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-7 change enabled=0 to enabled=1 and quite and save the file with :qw"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Blog","item":"https://blog.marcelwidmer.org/blog/"},{"@type":"ListItem","position":3,"name":"Certbot Let`s Encrypt","item":"https://blog.marcelwidmer.org/blog/2019/2019-08-20-certbot-letsencrypt/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Certbot Let`s Encrypt","name":"Certbot Let`s Encrypt","description":"Inspiration from [Adding an SSL certificate to OKD - Part 2 of Installation of OKD 3.10 from start to finish]https://www.youtube.com/watch?v=S7HoJ09oYn0\u0026amp;feature=youtu.be){:target=\u0026quot;_blank\u0026quot;}\nCheck Certificate Let`s check first if there a certificate already for our domain https://crt.sh/?q=c3smonkey.ch\nCheck EPEL Reposittory Check if the epel.repo is enabled.\n$ vi /etc/yum.repos.d/epel.repo [epel] name=Extra Packages for Enterprise Linux 7 - $basearch #baseurl=http://download.fedoraproject.org/pub/epel/7/$basearch metalink=https://mirrors.fedoraproject.org/metalink?repo=epel-7\u0026amp;arch=$basearch failovermethod=priority enabled=0 gpgcheck=1 gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-7 change enabled=0 to enabled=1 and quite and save the file with :qw","keywords":["k8s","Let's Encrypt"],"articleBody":"Inspiration from [Adding an SSL certificate to OKD - Part 2 of Installation of OKD 3.10 from start to finish]https://www.youtube.com/watch?v=S7HoJ09oYn0\u0026feature=youtu.be){:target=\"_blank\"}\nCheck Certificate Let`s check first if there a certificate already for our domain https://crt.sh/?q=c3smonkey.ch\nCheck EPEL Reposittory Check if the epel.repo is enabled.\n$ vi /etc/yum.repos.d/epel.repo [epel] name=Extra Packages for Enterprise Linux 7 - $basearch #baseurl=http://download.fedoraproject.org/pub/epel/7/$basearch metalink=https://mirrors.fedoraproject.org/metalink?repo=epel-7\u0026arch=$basearch failovermethod=priority enabled=0 gpgcheck=1 gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-7 change enabled=0 to enabled=1 and quite and save the file with :qw\nLogin to the Cluster Login to the Cluster with the oc login command. Check if you are in the project default other wise change to the default project with oc project default\n$ [root@c3smonkey ~]# oc login Authentication required for https://console.c3smonkey.ch:8443 (openshift) Username: monkey Password: Login successful. You have access to the following projects and can switch between them with 'oc project ': * default development jenkins Verify if you are in the default project namespace.\n$ [root@c3smonkey ~]# oc project Using project \"default\" on server \"https://console.c3smonkey.ch:8443\". To create our certificate with certbot we take the temporary webserver approach. For this we have to scale done one pod on the cluster who are running already on the port 80.\nSearch Router and scale it down. With the oc get dc we can check if the router is running.\n$ [root@c3smonkey ~]# oc get dc NAME REVISION DESIRED CURRENT TRIGGERED BY docker-registry 1 1 1 config registry-console 1 1 1 config router 1 1 1 config Now we can scale it down with oc scale --replicas=0 dc router\n$ oc scale --replicas=0 dc router deploymentconfig.apps.openshift.io/router scaled Lets verify if the router not running before we install and run the certbot with the oc get dc command like before.\n$ [root@c3smonkey ~]# oc get dc NAME REVISION DESIRED CURRENT TRIGGERED BY docker-registry 1 1 1 config registry-console 1 1 1 config router 1 0 0 config Lets install the certbot now with the yum install certbot command.\n$ [root@c3smonkey ~]# yum install certbot Check if the DNS server is setup is correct. Important * CNAME is pointing to apps.console We need this because whne we deploy new application this will create a URL under apps and the namespace.\n* 420 IN CNAME apps.console @ 1800 IN A 95.216.193.150 apps.console 300 IN A 95.216.193.150 console 300 IN A 95.216.193.150 Here you can verify the domain names dnschecker.org Ok let`s create some certificate for the following domain names\nc3smonkey.ch console.c3smonkey.ch jenkins-jenkins.apps.c3smonkey.ch grafana-openshift-monitoring.apps.c3smonkey.ch apps.c3smonkey.ch hawkular-metrics.apps.c3smonkey.ch $ [root@c3smonkey ~]# certbot certonly --server https://acme-v02.api.letsencrypt.org/directory \\ --standalone \\ -d console.c3smonkey.ch \\ -d jenkins-jenkins.apps.c3smonkey.ch \\ -d c3smonkey.ch \\ -d grafana-openshift-monitoring.apps.c3smonkey.ch \\ -d apps.c3smonkey.ch \\ -d hawkular-metrics.apps.c3smonkey.ch After this command you see something like this\nThe certificate are located under /etc/letsencrypt/live/console.c3smonkey.ch/\n$ root@c3smonkey installcentos]# ls -lisa /etc/letsencrypt/live/console.c3smonkey.ch/ total 12 1258906 4 drwxr-xr-x. 2 root root 4096 Aug 26 21:06 . 1258902 4 drwx------. 3 root root 4096 Aug 26 21:06 .. 1258915 4 -rw-r--r--. 1 root root 692 Aug 26 21:06 README 1258907 0 lrwxrwxrwx. 1 root root 44 Aug 26 21:06 cert.pem -\u003e ../../archive/console.c3smonkey.ch/cert1.pem 1258909 0 lrwxrwxrwx. 1 root root 45 Aug 26 21:06 chain.pem -\u003e ../../archive/console.c3smonkey.ch/chain1.pem 1258910 0 lrwxrwxrwx. 1 root root 49 Aug 26 21:06 fullchain.pem -\u003e ../../archive/console.c3smonkey.ch/fullchain1.pem 1258908 0 lrwxrwxrwx. 1 root root 47 Aug 26 21:06 privkey.pem -\u003e ../../archive/console.c3smonkey.ch/privkey1.pem Now we can scale up our route with oc scale --replicas=1 dc router and verify it with oc get dc\n$ [root@c3smonkey]# oc scale --replicas=1 dc router deploymentconfig.apps.openshift.io/router scaled [root@c3smonkey]# oc get dc NAME REVISION DESIRED CURRENT TRIGGERED BY docker-registry 1 1 1 config registry-console 1 1 1 config router 1 1 1 config [root@c3smonkey installcentos]# Now we have to patch the installation inventory.ini file for this we will take the vi We will add the following section on the bottom of the file.\nopenshift_master_overwrite_named_certificates=true openshift_master_named_certificates=[{\"certfile\": \"/etc/letsencrypt/live/console.c3smonkey.ch/cert.pem\", \"keyfile\": \"/etc/letsencrypt/live/console.c3smonkey.ch/privkey.pem\",\"names\": [\"c3smonkey.ch\", \"console.c3smonkey.ch\", \"jenkins-jenkins.apps.c3smonkey.ch\", \"grafana-openshift-monitoring.apps.c3smonkey.ch\", \"apps.c3smonkey.ch\", \"hawkular-metrics.apps.c3smonkey.ch\"] }] The meaning of this configuration is basically that we override the master cluster certificate with the flag true in openshift_master_overwrite_named_certificates=true and add all named certificates we created with the certbot command from before.\nc3smonkey.ch console.c3smonkey.ch jenkins-jenkins.apps.c3smonkey.ch grafana-openshift-monitoring.apps.c3smonkey.ch apps.c3smonkey.ch hawkular-metrics.apps.c3smonkey.ch let us change the directory first and jump in the installation directory cd installcentos\n$ [root@c3smonkey ~]# cd installcentos/ Now let’s apply two ansible script but for this lets search the ansible scripts we need with cat install-openshift.sh | grep ansible\n$ [root@c3smonkey installcentos]# cat install-openshift.sh | grep ansible curl -o ansible.rpm https://releases.ansible.com/ansible/rpm/release/epel-7-x86_64/ansible-2.6.5-1.el7.ans.noarch.rpm yum -y --enablerepo=epel install ansible.rpm [ ! -d openshift-ansible ] \u0026\u0026 git clone https://github.com/openshift/openshift-ansible.git # cd openshift-ansible \u0026\u0026 git fetch \u0026\u0026 git checkout release-${VERSION} \u0026\u0026 git checkout e7f05191a1 \u0026\u0026 cd .. cd openshift-ansible \u0026\u0026 git fetch \u0026\u0026 git checkout release-${VERSION} \u0026\u0026 cd .. # https://github.com/openshift/openshift-ansible/issues/11069 ansible-playbook -i inventory.ini openshift-ansible/playbooks/prerequisites.yml ansible-playbook -i inventory.ini openshift-ansible/playbooks/deploy_cluster.yml The first one we will apply is the prerequisites playbook to check if everything is still good.\n$ [root@c3smonkey installcentos]# ansible-playbook -i inventory.ini openshift-ansible/playbooks/prerequisites.yml Lets play the second playbook who will replace the certificate we just created.\n$ [root@c3smonkey installcentos]# ansible-playbook -i inventory.ini openshift-ansible/playbooks/deploy_cluster.yml When it stuck and the API server don’t come back up just rerun the script. or run playbooks/openshift-master/config.yml\n$ [root@c3smonkey installcentos]# ansible-playbook -i inventory.ini openshift-ansible/playbooks/openshift-master/config.yml This will take a time dependence of your host. Now reboot the cluster with shutdown -r now\n$ [root@c3smonkey installcentos]# shutdown -r now Let us check the certificate https://crt.sh/?q=c3smonkey.ch Open a new tab and open the https://console.c3smonkey.ch:8443/ to check if the certificate are installed successfully.\nBackup Certificates $ scp root@c3smonkey.ch:/etc/letsencrypt/live/console.c3smonkey.ch/\\*.pem ~/dev/c3smonkey/hetzner-okd-ansible/cert/ Restore Certificates First create the following folder structure /etc/letsencrypt/live/console.c3smonkey.ch/ on the remote host.\n$ [root@c3smonkey ~]# mkdir -p /etc/letsencrypt/live/console.c3smonkey.ch/ Lets copy the files cert.pem chain.pem fullchain.pem privkey.pemto the folder from your local backup.\n$ scp ~/dev/c3smonkey/hetzner-okd-ansible/cert/cert.pem root@c3smonkey.ch:/etc/letsencrypt/live/console.c3smonkey.ch/ $ scp ~/dev/c3smonkey/hetzner-okd-ansible/cert/chain.pem root@c3smonkey.ch:/etc/letsencrypt/live/console.c3smonkey.ch/ $ scp ~/dev/c3smonkey/hetzner-okd-ansible/cert/fullchain.pem root@c3smonkey.ch:/etc/letsencrypt/live/console.c3smonkey.ch/ $ scp ~/dev/c3smonkey/hetzner-okd-ansible/cert/privkey.pem root@c3smonkey.ch:/etc/letsencrypt/live/console.c3smonkey.ch/ ","wordCount":"947","inLanguage":"en","datePublished":"2019-01-13T00:00:00Z","dateModified":"2019-01-13T00:00:00Z","author":{"@type":"Person","name":"Marcel Widmer"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.marcelwidmer.org/blog/2019/2019-08-20-certbot-letsencrypt/"},"publisher":{"@type":"Organization","name":"c3smonkey's blog","logo":{"@type":"ImageObject","url":"https://blog.marcelwidmer.org/static/favicon.ico"}}}</script></head><body><nav class=desktop><ul><li><a class=logo href=https://blog.marcelwidmer.org accesskey=h title="Welcome to my blog (Alt + h)"><img src=/static/favicon.ico alt="Welcome to my blog" width=35 height=35></img><h3 style=margin-bottom:0><strong><em>c3smonkey&rsquo;s blog</em></strong></h3></a></li><li class=toggle-container><input type=checkbox id=switch>
<label for=switch><i id=darkIcon data-feather=moon></i>
<i id=lightIcon data-feather=sun></i></label></li></ul><ul class=desktop-navigation><li><a href=/blog title=Blog><i data-feather=pen-tool></i>
<span>Blog</span></a></li><li><a href=/search title="Search (Alt + /)" accesskey=/><i data-feather=search></i>
<span>Search</span></a></li><li><a href=/contact title=Contact><i data-feather=mail></i>
<span>Contact</span></a></li><li><a href=https://github.com/marzelwidmer title=Github><i data-feather=github></i>
<span></span></a></li></ul><ul class=mobile-navigation><li><button id=menuOpen onclick=openMobile() aria-label="Menu closed">
<i data-feather=menu></i></button>
<button id=menuClose onclick=openMobile() aria-label="Menu opened">
<i data-feather=x></i></button></li></ul></nav><aside class=sidebar id=mobileNav style=display:none><nav><ul><li><a href=/blog title=Blog><span><i data-feather=pen-tool></i>
Blog</span></a></li><li><a href=/search title="Search (Alt + /)" accesskey=/><span><i data-feather=search></i>
Search</span></a></li><li><a href=/contact title=Contact><span><i data-feather=mail></i>
Contact</span></a></li><li><a href=https://github.com/marzelwidmer title=Github><span><i data-feather=github></i></span></a></li></ul></nav></aside><main><div class=container><hgroup><div><a href=https://blog.marcelwidmer.org>Home</a>&nbsp;»&nbsp;<a href=https://blog.marcelwidmer.org/blog/>Blog</a></div><h1>Certbot Let`s Encrypt</h1><time datetime='2019-01-13 00:00:00 +0000 UTC'>January 13, 2019</time>&nbsp;·&nbsp;5 min&nbsp;·&nbsp;Marcel Widmer<p></p></hgroup><a href=https://blog.marcelwidmer.org/tags/k8s/><kbd>k8s</kbd></a>
<a href=https://blog.marcelwidmer.org/tags/lets-encrypt/><kbd>Let's Encrypt</kbd></a><div class="grid grid-main"><div><div class=post><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Certbot Let`s Encrypt on twitter" href="https://twitter.com/intent/tweet/?text=Certbot%20Let%60s%20Encrypt&url=https%3a%2f%2fblog.marcelwidmer.org%2fblog%2f2019%2f2019-08-20-certbot-letsencrypt%2f&hashtags=k8s%2cLet%27sEncrypt"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Certbot Let`s Encrypt on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fblog.marcelwidmer.org%2fblog%2f2019%2f2019-08-20-certbot-letsencrypt%2f&title=Certbot%20Let%60s%20Encrypt&summary=Certbot%20Let%60s%20Encrypt&source=https%3a%2f%2fblog.marcelwidmer.org%2fblog%2f2019%2f2019-08-20-certbot-letsencrypt%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Certbot Let`s Encrypt on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fblog.marcelwidmer.org%2fblog%2f2019%2f2019-08-20-certbot-letsencrypt%2f&title=Certbot%20Let%60s%20Encrypt"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Certbot Let`s Encrypt on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.marcelwidmer.org%2fblog%2f2019%2f2019-08-20-certbot-letsencrypt%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Certbot Let`s Encrypt on whatsapp" href="https://api.whatsapp.com/send?text=Certbot%20Let%60s%20Encrypt%20-%20https%3a%2f%2fblog.marcelwidmer.org%2fblog%2f2019%2f2019-08-20-certbot-letsencrypt%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Certbot Let`s Encrypt on telegram" href="https://telegram.me/share/url?text=Certbot%20Let%60s%20Encrypt&url=https%3a%2f%2fblog.marcelwidmer.org%2fblog%2f2019%2f2019-08-20-certbot-letsencrypt%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div><p>Inspiration from [Adding an SSL certificate to OKD - Part 2 of Installation of OKD 3.10 from start to finish]https://www.youtube.com/watch?v=S7HoJ09oYn0&feature=youtu.be){:target="_blank"}</p><h2 id=check-certificate>Check Certificate<a class=anchor aria-hidden=true href=#check-certificate>#</a></h2><p>Let`s check first if there a certificate already for our domain <a href="https://crt.sh/?q=c3smonkey.ch" target=_blank rel=noopener>https://crt.sh/?q=c3smonkey.ch</a></p><p><img src=/static/certbot/crt.png alt=crt></p><h2 id=check-epel-reposittory>Check EPEL Reposittory<a class=anchor aria-hidden=true href=#check-epel-reposittory>#</a></h2><p>Check if the <code>epel.repo</code> is enabled.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ vi /etc/yum.repos.d/epel.repo
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>[<span style=color:#ae81ff>epel]</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>name=Extra Packages for Enterprise Linux 7 - $basearch</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#baseurl=http://download.fedoraproject.org/pub/epel/7/$basearch</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>metalink=https://mirrors.fedoraproject.org/metalink?repo=epel-7&amp;arch=$basearch</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>failovermethod=priority</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>enabled=0</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>gpgcheck=1</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-7</span>
</span></span></code></pre></div><p>change <code>enabled=0</code> to <code>enabled=1</code> and quite and save the file with <code>:qw</code></p><h2 id=login-to-the-cluster>Login to the Cluster<a class=anchor aria-hidden=true href=#login-to-the-cluster>#</a></h2><p>Login to the Cluster with the <code>oc login</code> command. Check if you are in the project <code>default</code> other wise change to the <code>default</code> project with <code>oc project default</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ <span style=color:#f92672>[</span>root@c3smonkey ~<span style=color:#f92672>]</span><span style=color:#75715e># oc login</span>
</span></span><span style=display:flex><span>Authentication required <span style=color:#66d9ef>for</span> https://console.c3smonkey.ch:8443 <span style=color:#f92672>(</span>openshift<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Username: monkey
</span></span><span style=display:flex><span>Password: 
</span></span><span style=display:flex><span>Login successful.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>You have access to the following projects and can switch between them with <span style=color:#e6db74>&#39;oc project &lt;projectname&gt;&#39;</span>:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  * default
</span></span><span style=display:flex><span>    development
</span></span><span style=display:flex><span>    jenkins
</span></span></code></pre></div><p>Verify if you are in the <code>default</code> project namespace.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ <span style=color:#f92672>[</span>root@c3smonkey ~<span style=color:#f92672>]</span><span style=color:#75715e># oc project</span>
</span></span><span style=display:flex><span>Using project <span style=color:#e6db74>&#34;default&#34;</span> on server <span style=color:#e6db74>&#34;https://console.c3smonkey.ch:8443&#34;</span>.
</span></span></code></pre></div><p>To create our certificate with <code>certbot</code> we take the temporary webserver approach. For this we have to scale done one <code>pod</code> on the cluster
who are running already on the port <code>80</code>.</p><h3 id=search-router-and-scale-it-down>Search Router and scale it down.<a class=anchor aria-hidden=true href=#search-router-and-scale-it-down>#</a></h3><p>With the <code>oc get dc</code> we can check if the router is running.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ <span style=color:#f92672>[</span>root@c3smonkey ~<span style=color:#f92672>]</span><span style=color:#75715e># oc get dc</span>
</span></span><span style=display:flex><span>NAME               REVISION   DESIRED   CURRENT   TRIGGERED BY
</span></span><span style=display:flex><span>docker-registry    <span style=color:#ae81ff>1</span>          <span style=color:#ae81ff>1</span>         <span style=color:#ae81ff>1</span>         config
</span></span><span style=display:flex><span>registry-console   <span style=color:#ae81ff>1</span>          <span style=color:#ae81ff>1</span>         <span style=color:#ae81ff>1</span>         config
</span></span><span style=display:flex><span>router             <span style=color:#ae81ff>1</span>          <span style=color:#ae81ff>1</span>         <span style=color:#ae81ff>1</span>         config
</span></span></code></pre></div><p>Now we can scale it down with <code>oc scale --replicas=0 dc router</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ oc scale --replicas<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> dc router
</span></span><span style=display:flex><span>deploymentconfig.apps.openshift.io/router scaled
</span></span></code></pre></div><p>Lets verify if the router not running before we install and run the <code>certbot</code> with the <code>oc get dc</code> command like before.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ <span style=color:#f92672>[</span>root@c3smonkey ~<span style=color:#f92672>]</span><span style=color:#75715e># oc get dc</span>
</span></span><span style=display:flex><span>NAME               REVISION   DESIRED   CURRENT   TRIGGERED BY
</span></span><span style=display:flex><span>docker-registry    <span style=color:#ae81ff>1</span>          <span style=color:#ae81ff>1</span>         <span style=color:#ae81ff>1</span>         config
</span></span><span style=display:flex><span>registry-console   <span style=color:#ae81ff>1</span>          <span style=color:#ae81ff>1</span>         <span style=color:#ae81ff>1</span>         config
</span></span><span style=display:flex><span>router             <span style=color:#ae81ff>1</span>          <span style=color:#ae81ff>0</span>         <span style=color:#ae81ff>0</span>         config
</span></span></code></pre></div><p>Lets install the <code>certbot</code> now with the <code>yum install certbot</code> command.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ <span style=color:#f92672>[</span>root@c3smonkey ~<span style=color:#f92672>]</span><span style=color:#75715e># yum install certbot</span>
</span></span></code></pre></div><p>Check if the DNS server is setup is correct. Important <code>*</code> <code>CNAME</code> is pointing to <code>apps.console</code>
We need this because whne we deploy new application this will create a URL under apps and the namespace.</p><pre tabindex=0><code class=language-haml data-lang=haml>*                420    IN      CNAME   apps.console
@               1800    IN      A       95.216.193.150
apps.console     300    IN      A       95.216.193.150
console          300    IN      A       95.216.193.150
</code></pre><p>Here you can verify the domain names <a href=https://dnschecker.org/#A/c3smonkey.ch target=_blank rel=noopener>dnschecker.org</a>
Ok let`s create some certificate for the following domain names</p><ul><li>c3smonkey.ch</li><li>console.c3smonkey.ch</li><li>jenkins-jenkins.apps.c3smonkey.ch</li><li>grafana-openshift-monitoring.apps.c3smonkey.ch</li><li>apps.c3smonkey.ch</li><li>hawkular-metrics.apps.c3smonkey.ch</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ <span style=color:#f92672>[</span>root@c3smonkey ~<span style=color:#f92672>]</span><span style=color:#75715e># certbot certonly --server https://acme-v02.api.letsencrypt.org/directory \</span>
</span></span><span style=display:flex><span>    --standalone <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -d console.c3smonkey.ch <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -d jenkins-jenkins.apps.c3smonkey.ch <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -d c3smonkey.ch <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -d grafana-openshift-monitoring.apps.c3smonkey.ch <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -d apps.c3smonkey.ch <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -d hawkular-metrics.apps.c3smonkey.ch
</span></span></code></pre></div><p>After this command you see something like this</p><p><img src=/static/certbot/certbot-result.png alt=certbot-result></p><p>The certificate are located under <code>/etc/letsencrypt/live/console.c3smonkey.ch/</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ root@c3smonkey installcentos<span style=color:#f92672>]</span><span style=color:#75715e># ls -lisa /etc/letsencrypt/live/console.c3smonkey.ch/</span>
</span></span><span style=display:flex><span>total <span style=color:#ae81ff>12</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>1258906</span> <span style=color:#ae81ff>4</span> drwxr-xr-x. <span style=color:#ae81ff>2</span> root root <span style=color:#ae81ff>4096</span> Aug <span style=color:#ae81ff>26</span> 21:06 .
</span></span><span style=display:flex><span><span style=color:#ae81ff>1258902</span> <span style=color:#ae81ff>4</span> drwx------. <span style=color:#ae81ff>3</span> root root <span style=color:#ae81ff>4096</span> Aug <span style=color:#ae81ff>26</span> 21:06 ..
</span></span><span style=display:flex><span><span style=color:#ae81ff>1258915</span> <span style=color:#ae81ff>4</span> -rw-r--r--. <span style=color:#ae81ff>1</span> root root  <span style=color:#ae81ff>692</span> Aug <span style=color:#ae81ff>26</span> 21:06 README
</span></span><span style=display:flex><span><span style=color:#ae81ff>1258907</span> <span style=color:#ae81ff>0</span> lrwxrwxrwx. <span style=color:#ae81ff>1</span> root root   <span style=color:#ae81ff>44</span> Aug <span style=color:#ae81ff>26</span> 21:06 cert.pem -&gt; ../../archive/console.c3smonkey.ch/cert1.pem
</span></span><span style=display:flex><span><span style=color:#ae81ff>1258909</span> <span style=color:#ae81ff>0</span> lrwxrwxrwx. <span style=color:#ae81ff>1</span> root root   <span style=color:#ae81ff>45</span> Aug <span style=color:#ae81ff>26</span> 21:06 chain.pem -&gt; ../../archive/console.c3smonkey.ch/chain1.pem
</span></span><span style=display:flex><span><span style=color:#ae81ff>1258910</span> <span style=color:#ae81ff>0</span> lrwxrwxrwx. <span style=color:#ae81ff>1</span> root root   <span style=color:#ae81ff>49</span> Aug <span style=color:#ae81ff>26</span> 21:06 fullchain.pem -&gt; ../../archive/console.c3smonkey.ch/fullchain1.pem
</span></span><span style=display:flex><span><span style=color:#ae81ff>1258908</span> <span style=color:#ae81ff>0</span> lrwxrwxrwx. <span style=color:#ae81ff>1</span> root root   <span style=color:#ae81ff>47</span> Aug <span style=color:#ae81ff>26</span> 21:06 privkey.pem -&gt; ../../archive/console.c3smonkey.ch/privkey1.pem
</span></span></code></pre></div><p>Now we can scale up our route with <code>oc scale --replicas=1 dc router</code> and verify it with <code>oc get dc</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ <span style=color:#f92672>[</span>root@c3smonkey<span style=color:#f92672>]</span><span style=color:#75715e># oc scale --replicas=1 dc router</span>
</span></span><span style=display:flex><span>deploymentconfig.apps.openshift.io/router scaled
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@c3smonkey<span style=color:#f92672>]</span><span style=color:#75715e># oc get dc</span>
</span></span><span style=display:flex><span>NAME               REVISION   DESIRED   CURRENT   TRIGGERED BY
</span></span><span style=display:flex><span>docker-registry    <span style=color:#ae81ff>1</span>          <span style=color:#ae81ff>1</span>         <span style=color:#ae81ff>1</span>         config
</span></span><span style=display:flex><span>registry-console   <span style=color:#ae81ff>1</span>          <span style=color:#ae81ff>1</span>         <span style=color:#ae81ff>1</span>         config
</span></span><span style=display:flex><span>router             <span style=color:#ae81ff>1</span>          <span style=color:#ae81ff>1</span>         <span style=color:#ae81ff>1</span>         config
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@c3smonkey installcentos<span style=color:#f92672>]</span><span style=color:#75715e>#</span>
</span></span></code></pre></div><p>Now we have to patch the installation <code>inventory.ini</code> file for this we will take the <code>vi</code>
We will add the following section on the bottom of the file.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ae81ff>openshift_master_overwrite_named_certificates=true</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>openshift_master_named_certificates=[{&#34;certfile&#34;: &#34;/etc/letsencrypt/live/console.c3smonkey.ch/cert.pem&#34;, &#34;keyfile&#34;: &#34;/etc/letsencrypt/live/console.c3smonkey.ch/privkey.pem&#34;,&#34;names&#34;: [&#34;c3smonkey.ch&#34;, &#34;console.c3smonkey.ch&#34;, &#34;jenkins-jenkins.apps.c3smonkey.ch&#34;, &#34;grafana-openshift-monitoring.apps.c3smonkey.ch&#34;, &#34;apps.c3smonkey.ch&#34;, &#34;hawkular-metrics.apps.c3smonkey.ch&#34;] }]</span>
</span></span></code></pre></div><p>The meaning of this configuration is basically that we override the master cluster certificate with the flag <code>true</code> in <code>openshift_master_overwrite_named_certificates=true</code>
and add all named certificates we created with the <code>certbot</code> command from before.</p><ul><li>c3smonkey.ch</li><li>console.c3smonkey.ch</li><li>jenkins-jenkins.apps.c3smonkey.ch</li><li>grafana-openshift-monitoring.apps.c3smonkey.ch</li><li>apps.c3smonkey.ch</li><li>hawkular-metrics.apps.c3smonkey.ch</li></ul><p>let us change the directory first and jump in the installation directory <code>cd installcentos</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ <span style=color:#f92672>[</span>root@c3smonkey ~<span style=color:#f92672>]</span><span style=color:#75715e># cd installcentos/</span>
</span></span></code></pre></div><p>Now let&rsquo;s apply two ansible script but for this lets search the ansible scripts we need with <code>cat install-openshift.sh | grep ansible</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ <span style=color:#f92672>[</span>root@c3smonkey installcentos<span style=color:#f92672>]</span><span style=color:#75715e># cat install-openshift.sh | grep ansible</span>
</span></span><span style=display:flex><span>curl -o ansible.rpm https://releases.ansible.com/ansible/rpm/release/epel-7-x86_64/ansible-2.6.5-1.el7.ans.noarch.rpm
</span></span><span style=display:flex><span>yum -y --enablerepo<span style=color:#f92672>=</span>epel install ansible.rpm
</span></span><span style=display:flex><span><span style=color:#f92672>[</span> ! -d openshift-ansible <span style=color:#f92672>]</span> <span style=color:#f92672>&amp;&amp;</span> git clone https://github.com/openshift/openshift-ansible.git
</span></span><span style=display:flex><span><span style=color:#75715e># cd openshift-ansible &amp;&amp; git fetch &amp;&amp; git checkout release-${VERSION} &amp;&amp; git checkout e7f05191a1 &amp;&amp; cd ..</span>
</span></span><span style=display:flex><span>cd openshift-ansible <span style=color:#f92672>&amp;&amp;</span> git fetch <span style=color:#f92672>&amp;&amp;</span> git checkout release-<span style=color:#e6db74>${</span>VERSION<span style=color:#e6db74>}</span> <span style=color:#f92672>&amp;&amp;</span> cd ..
</span></span><span style=display:flex><span><span style=color:#75715e># https://github.com/openshift/openshift-ansible/issues/11069</span>
</span></span><span style=display:flex><span>ansible-playbook -i inventory.ini openshift-ansible/playbooks/prerequisites.yml
</span></span><span style=display:flex><span>ansible-playbook -i inventory.ini openshift-ansible/playbooks/deploy_cluster.yml
</span></span></code></pre></div><p>The first one we will apply is the <code>prerequisites</code> playbook to check if everything is still good.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ <span style=color:#f92672>[</span>root@c3smonkey installcentos<span style=color:#f92672>]</span><span style=color:#75715e># ansible-playbook -i inventory.ini openshift-ansible/playbooks/prerequisites.yml</span>
</span></span></code></pre></div><p><img src=/static/certbot/prerequisites.png alt=prerequisites></p><p>Lets play the second playbook who will replace the certificate we just created.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ <span style=color:#f92672>[</span>root@c3smonkey installcentos<span style=color:#f92672>]</span><span style=color:#75715e># ansible-playbook -i inventory.ini openshift-ansible/playbooks/deploy_cluster.yml</span>
</span></span></code></pre></div><p>When it stuck and the API server don&rsquo;t come back up just rerun the script.
or run <code>playbooks/openshift-master/config.yml</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ <span style=color:#f92672>[</span>root@c3smonkey installcentos<span style=color:#f92672>]</span><span style=color:#75715e># ansible-playbook -i inventory.ini openshift-ansible/playbooks/openshift-master/config.yml</span>
</span></span></code></pre></div><p><img src=/static/certbot/deploy_cluster-failed.png alt=deploy_cluster-failed></p><p>This will take a time dependence of your host.
<img src=/static/certbot/openshift-certbot/htop.png alt=htop></p><p>Now reboot the cluster with <code>shutdown -r now</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ <span style=color:#f92672>[</span>root@c3smonkey installcentos<span style=color:#f92672>]</span><span style=color:#75715e># shutdown -r now</span>
</span></span></code></pre></div><p>Let us check the certificate <a href="https://crt.sh/?q=c3smonkey.ch" target=_blank rel=noopener>https://crt.sh/?q=c3smonkey.ch</a>
<img src=/static/certbot/crt-lets-encrypt.png alt=crt></p><p>Open a new tab and open the <a href=https://console.c3smonkey.ch:8443/ target=_blank rel=noopener>https://console.c3smonkey.ch:8443/</a> to check if the certificate are installed successfully.</p><h2 id=backup-certificates>Backup Certificates<a class=anchor aria-hidden=true href=#backup-certificates>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ scp root@c3smonkey.ch:/etc/letsencrypt/live/console.c3smonkey.ch/<span style=color:#ae81ff>\*</span>.pem ~/dev/c3smonkey/hetzner-okd-ansible/cert/
</span></span></code></pre></div><h2 id=restore-certificates>Restore Certificates<a class=anchor aria-hidden=true href=#restore-certificates>#</a></h2><p>First create the following folder structure <code>/etc/letsencrypt/live/console.c3smonkey.ch/</code> on the remote host.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ <span style=color:#f92672>[</span>root@c3smonkey ~<span style=color:#f92672>]</span><span style=color:#75715e># mkdir -p /etc/letsencrypt/live/console.c3smonkey.ch/</span>
</span></span></code></pre></div><p>Lets copy the files <code>cert.pem</code> <code>chain.pem</code> <code>fullchain.pem</code> <code>privkey.pem</code>to the folder from your local backup.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ scp ~/dev/c3smonkey/hetzner-okd-ansible/cert/cert.pem  root@c3smonkey.ch:/etc/letsencrypt/live/console.c3smonkey.ch/
</span></span><span style=display:flex><span>$ scp ~/dev/c3smonkey/hetzner-okd-ansible/cert/chain.pem  root@c3smonkey.ch:/etc/letsencrypt/live/console.c3smonkey.ch/
</span></span><span style=display:flex><span>$ scp ~/dev/c3smonkey/hetzner-okd-ansible/cert/fullchain.pem  root@c3smonkey.ch:/etc/letsencrypt/live/console.c3smonkey.ch/
</span></span><span style=display:flex><span>$ scp ~/dev/c3smonkey/hetzner-okd-ansible/cert/privkey.pem  root@c3smonkey.ch:/etc/letsencrypt/live/console.c3smonkey.ch/
</span></span></code></pre></div></div><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Certbot Let`s Encrypt on twitter" href="https://twitter.com/intent/tweet/?text=Certbot%20Let%60s%20Encrypt&url=https%3a%2f%2fblog.marcelwidmer.org%2fblog%2f2019%2f2019-08-20-certbot-letsencrypt%2f&hashtags=k8s%2cLet%27sEncrypt"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Certbot Let`s Encrypt on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fblog.marcelwidmer.org%2fblog%2f2019%2f2019-08-20-certbot-letsencrypt%2f&title=Certbot%20Let%60s%20Encrypt&summary=Certbot%20Let%60s%20Encrypt&source=https%3a%2f%2fblog.marcelwidmer.org%2fblog%2f2019%2f2019-08-20-certbot-letsencrypt%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Certbot Let`s Encrypt on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fblog.marcelwidmer.org%2fblog%2f2019%2f2019-08-20-certbot-letsencrypt%2f&title=Certbot%20Let%60s%20Encrypt"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Certbot Let`s Encrypt on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.marcelwidmer.org%2fblog%2f2019%2f2019-08-20-certbot-letsencrypt%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Certbot Let`s Encrypt on whatsapp" href="https://api.whatsapp.com/send?text=Certbot%20Let%60s%20Encrypt%20-%20https%3a%2f%2fblog.marcelwidmer.org%2fblog%2f2019%2f2019-08-20-certbot-letsencrypt%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Certbot Let`s Encrypt on telegram" href="https://telegram.me/share/url?text=Certbot%20Let%60s%20Encrypt&url=https%3a%2f%2fblog.marcelwidmer.org%2fblog%2f2019%2f2019-08-20-certbot-letsencrypt%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></div><aside><article><h3>See Also</h3><a href=/blog/2019/2019-01-13-hetzner-okd/><hgroup><h4><i>Install OKD on Hetzner Cloud</i></h4><p><time datetime='2019-01-13 00:00:00 +0000 UTC'>January 13, 2019</time>&nbsp;·&nbsp;9 min&nbsp;·&nbsp;Marcel Widmer</p></hgroup></a></article></aside></div></div></main><footer class=text-center><span>&copy; 2022 <a href=https://blog.marcelwidmer.org>c3smonkey's blog</a></span><div><a href=https://blog.marcelwidmer.org/legal/privacy>Privacy Policy</a>
<span>&</span>
<a href=https://blog.marcelwidmer.org/legal/terms-and-conditions>Terms and Conditions</a></div></footer><article class=hidden id=cookie-banner><div><span></span></div><footer><a role=button id=consent-cookies>Close</a>
<a role=button class=secondary href=/></a></footer></article><script async src=https://blog.marcelwidmer.org/js/cookie.min.js layout=container></script>
<script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("kbd");t.classList.add("copy-code"),t.innerText="copy";function s(){t.innerText="copied!",setTimeout(()=>{t.innerText="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script><script src=https://blog.marcelwidmer.org/plugins/js/feather.min.js layout=container></script>
<script src=https://blog.marcelwidmer.org/js/script.min.js layout=container></script></body></html>