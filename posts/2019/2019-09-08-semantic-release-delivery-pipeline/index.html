<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Table of contents # Setup Deployment Jenkins Pipeline WebHooks Private Repository Semantic Release Jenkins Pipeline Setup Deployment # $ oc new-project development --display-nam e=&#34;Development Environment&#34; Deploy application with the maven.fabric8.io plugin in development stage from local machine.
$ ./mvnw fabric8:deploy -Dfabric8.namespace=development $ oc policy add-role-to-user edit system:serviceaccount:jenkins:jenkins -n development Create testing project and setup the roles.
$ oc new-project testing --display-name=&#34;Testing Environment&#34; $ oc policy add-role-to-user edit system:serviceaccount:jenkins:jenkins -n testing $ oc policy add-role-to-group system:image-puller system:serviceaccounts:testing \ -n development Create DeploymentConfiguration in testing stage.">
<meta name="theme-color" content="#FFFFFF">
<meta name="color-scheme" content="light dark"><meta property="og:title" content="Semantic Release Delivery Pipeline" />
<meta property="og:description" content="Table of contents # Setup Deployment Jenkins Pipeline WebHooks Private Repository Semantic Release Jenkins Pipeline Setup Deployment # $ oc new-project development --display-nam e=&#34;Development Environment&#34; Deploy application with the maven.fabric8.io plugin in development stage from local machine.
$ ./mvnw fabric8:deploy -Dfabric8.namespace=development $ oc policy add-role-to-user edit system:serviceaccount:jenkins:jenkins -n development Create testing project and setup the roles.
$ oc new-project testing --display-name=&#34;Testing Environment&#34; $ oc policy add-role-to-user edit system:serviceaccount:jenkins:jenkins -n testing $ oc policy add-role-to-group system:image-puller system:serviceaccounts:testing \ -n development Create DeploymentConfiguration in testing stage." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/2019/2019-09-08-semantic-release-delivery-pipeline/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-09-08T00:00:00+00:00" />
<meta property="article:modified_time" content="2022-09-24T18:38:37+02:00" />

<title>Semantic Release Delivery Pipeline | Blog Marcel Widmer </title>
<link rel="manifest" href="/manifest.json">
<link rel="icon" href="/favicon.png" type="image/x-icon">
<link rel="stylesheet" href="/book.min.c58292d36b18b675680ab9baea2029204537b839ea72f258746ec0f32ce8d6c8.css" >
  <script defer src="/flexsearch.min.js"></script>
  <script defer src="/en.search.min.6d9040acb89aff39f832a0b8623fad42fa664a32ef333ca95112d6156a809515.js" ></script>

  <script defer src="/sw.min.6f6f90fcb8eb1c49ec389838e6b801d0de19430b8e516902f8d75c3c8bd98739.js" ></script>
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->
  
</head>
<body dir="ltr">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      <div class="book-menu-content">
        
  <nav>
<h2 class="book-brand">
  <a class="flex align-center" href="/"><img src="/avatar.png" alt="Logo" /><span>Blog Marcel Widmer </span>
  </a>
</h2>


<div class="book-search">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>



  



  
    
  



<ul class="book-languages">
  <li>
    <input type="checkbox" id="languages" class="toggle" />
    <label for="languages" class="flex justify-between">
      <a role="button" class="flex align-center">
        <img src="/svg/translate.svg" class="book-icon" alt="Languages" />
        English
      </a>
    </label>

    <ul>
      
      <li>
        <a href="/de/">
          Deutsch
        </a>
      </li>
      
    </ul>
  </li>
</ul>











  












  
<ul>
  
  <li>
    <a href="/posts/" >
        Blog
      </a>
  </li>
  
</ul>






</nav>




  <script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>


 
      </div>
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>Semantic Release Delivery Pipeline</strong>

  <label for="toc-control">
    
    <img src="/svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#table-of-contents">Table of contents</a>
      <ul>
        <li><a href="#SetupDeployment">Setup Deployment </a></li>
        <li><a href="#JenkinsPipeline">Jenkins Pipeline </a></li>
        <li><a href="#WebHooks">WebHooks</a></li>
        <li><a href="#privateRepo">Private Repository access with secrets</a></li>
        <li><a href="#SemanticReleaseJenkinsPipeline">Semantic Release Jenkins Pipeline </a></li>
      </ul>
    </li>
  </ul>
</nav>



  </aside>
  
 
      </header>

      
      
<article class="markdown">
  <h1>
    <a href="/posts/2019/2019-09-08-semantic-release-delivery-pipeline/">Semantic Release Delivery Pipeline</a>
  </h1>
  
  <h5>September 8, 2019</h5>



  
  <div>
    
      <a href="/categories/Kubernetes/">Kubernetes</a>
  </div>
  

  
  <div>
    
      <a href="/tags/k8s/">k8s</a>, 
      <a href="/tags/CI/CD/">CI/CD</a>
  </div>
  



<h1 id="table-of-contents">
  Table of contents
  <a class="anchor" href="#table-of-contents">#</a>
</h1>
<ul>
<li>
  <a href="#SetupDeployment">Setup Deployment</a></li>
<li>
  <a href="#JenkinsPipeline">Jenkins Pipeline</a></li>
<li>
  <a href="#WebHooks">WebHooks</a></li>
<li>
  <a href="#privateRepo">Private Repository</a></li>
<li>
  <a href="#SemanticReleaseJenkinsPipeline">Semantic Release Jenkins Pipeline</a></li>
</ul>
<h2 id="SetupDeployment">
  Setup Deployment 
  <a class="anchor" href="#SetupDeployment">#</a>
</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ oc new-project development --display-nam  e<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Development Environment&#34;</span>
</span></span></code></pre></div><p>Deploy application with the <code>maven.fabric8.io</code> plugin in  <code>development</code> stage from local machine.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ ./mvnw fabric8:deploy -Dfabric8.namespace<span style="color:#f92672">=</span>development
</span></span><span style="display:flex;"><span>$ oc policy add-role-to-user edit system:serviceaccount:jenkins:jenkins -n development
</span></span></code></pre></div><p>Create <code>testing</code> project and setup the roles.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ oc new-project testing --display-name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Testing Environment&#34;</span> 
</span></span><span style="display:flex;"><span>$ oc policy add-role-to-user edit system:serviceaccount:jenkins:jenkins -n testing
</span></span><span style="display:flex;"><span>$ oc policy add-role-to-group system:image-puller system:serviceaccounts:testing  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>          -n development
</span></span></code></pre></div><p>Create <code>DeploymentConfiguration</code> in <code>testing</code> stage.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ oc create dc customer-service --image<span style="color:#f92672">=</span>docker-registry.default.svc:5000/development/customer-service:promoteQA -n testing
</span></span><span style="display:flex;"><span>$ oc patch dc/customer-service  -p <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>     <span style="color:#e6db74">&#39;{&#34;spec&#34;:{&#34;template&#34;:{&#34;spec&#34;:{&#34;containers&#34;:[{&#34;name&#34;:&#34;default-container&#34;,&#34;imagePullPolicy&#34;:&#34;Always&#34;}]}}}}&#39;</span> -n testing
</span></span><span style="display:flex;"><span>$ oc expose dc customer-service -n testing --port<span style="color:#f92672">=</span><span style="color:#ae81ff">8080</span> 
</span></span><span style="display:flex;"><span>$ oc expose svc/customer-service -n testing
</span></span></code></pre></div><p>Create <code>production</code> project and setup the roles.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ oc new-project production --display-name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Production Environment&#34;</span> 
</span></span><span style="display:flex;"><span>$ oc policy add-role-to-user edit system:serviceaccount:jenkins:jenkins -n production
</span></span><span style="display:flex;"><span>$ oc policy add-role-to-group system:image-puller system:serviceaccounts:production  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>          -n development
</span></span></code></pre></div><p>Create <code>DeploymentConfiguration</code> in <code>production</code> stage.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ oc create dc customer-service --image<span style="color:#f92672">=</span>docker-registry.default.svc:5000/development/customer-service:promotePROD -n production
</span></span><span style="display:flex;"><span>$ oc patch dc/customer-service  -p <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>     <span style="color:#e6db74">&#39;{&#34;spec&#34;:{&#34;template&#34;:{&#34;spec&#34;:{&#34;containers&#34;:[{&#34;name&#34;:&#34;default-container&#34;,&#34;imagePullPolicy&#34;:&#34;Always&#34;}]}}}}&#39;</span> -n production
</span></span><span style="display:flex;"><span>$ oc expose dc customer-service -n production --port<span style="color:#f92672">=</span><span style="color:#ae81ff">8080</span>
</span></span><span style="display:flex;"><span>$ oc expose svc/customer-service -n production
</span></span></code></pre></div><h2 id="JenkinsPipeline">
  Jenkins Pipeline 
  <a class="anchor" href="#JenkinsPipeline">#</a>
</h2>
<p>Let&rsquo;s creat a Jenkins Pipeline for the <code>customer-service</code> in the project <code>jenkins</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ oc create -n jenkins -f <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    https://blog.marcelwidmer.org/semantic-release-delivery-pipeline/deploy/customer-service-pipeline.yaml
</span></span></code></pre></div><h2 id="WebHooks">
  WebHooks
  <a class="anchor" href="#WebHooks">#</a>
</h2>
<p>How we can create a 
  <a href="https://github.com/marzelwidmer/customer-service/settings/hooks">GitHub WebHook</a> for a public Git repository take a look at the following post there we created already a<br>

  <a href="http://blog.marcelwidmer.org/openshift-delivey-pipeline/#WebHooks">WebHook</a> for the <code>catalog-service</code> but here some <code>oc</code> commands
for the <code>customer-service</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ oc set triggers bc/customer-service-pipeline --from-github  -n jenkins 
</span></span></code></pre></div><p>Grab the <code>Secret</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ oc get bc/customer-service-pipeline -n jenkins -o json | jq <span style="color:#e6db74">&#39;.spec.triggers[].github.secret&#39;</span>
</span></span></code></pre></div><p>Grab <code>Webhook GitHub URL</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ oc describe bc/customer-service-pipeline -n jenkins
</span></span></code></pre></div><h2 id="privateRepo">
  Private Repository access with secrets
  <a class="anchor" href="#privateRepo">#</a>
</h2>
<p>Create a <code>generic secret</code> link this secret with the <code>builder</code>.
Annotate and label it for the Jenkins sync PlugIn. And finally update the <code>bc/customer-service-pipeline</code> with this secret.
First you have to create an <code>AccessToken</code> in your 
  <a href="https://github.com/settings/tokens">GitHub Tokens Settings</a> let it named like <code>openshift-source-builder</code>
add <code>repo</code> and <code>user</code> access because this token will be used for <code>Semantic Release</code></p>
<p>
  <img src="/static/semantic-release-delivery-pipeline/openshift-source-builder-github-token.png" alt="openshift-source-builder-github-token" /></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ oc create secret generic ci-user-at-github <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --from-literal<span style="color:#f92672">=</span>username<span style="color:#f92672">=</span>machineuser <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --from-literal<span style="color:#f92672">=</span>password<span style="color:#f92672">=</span>&lt;accesstoken&gt; <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --type<span style="color:#f92672">=</span>kubernetes.io/basic-auth <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      -n jenkins
</span></span><span style="display:flex;"><span>$ oc secrets link builder ci-user-at-github <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    -n jenkins
</span></span><span style="display:flex;"><span>$ oc annotate secret/ci-user-at-github <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      <span style="color:#e6db74">&#39;build.openshift.io/source-secret-match-uri-1=https://github.com/marzelwidmer/*&#39;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    -n jenkins
</span></span><span style="display:flex;"><span>$ oc label secret ci-user-at-github credential.sync.jenkins.openshift.io<span style="color:#f92672">=</span>true <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    -n jenkins
</span></span><span style="display:flex;"><span>$ oc set build-secret bc/customer-service-pipeline ci-user-at-github --source
</span></span></code></pre></div><p>When you check now the Jenkins you will see the <code>ci-user-at-github</code> under credentials <code>https://&lt;jenkins-url&gt;/credentials/</code></p>
<p>
  <img src="/static/semantic-release-delivery-pipeline/sync.jenkins.openshift.io.png" alt="sync.jenkins" /></p>
<p>You will also find the a secret <code>ci-user-at-github</code> in the <code>jenkins</code> project in the OpenShift console.</p>
<p>
  <img src="/static/semantic-release-delivery-pipeline/secret-ci-user-at-github.png" alt="secret-ci-user-at-github" /></p>
<h2 id="SemanticReleaseJenkinsPipeline">
  Semantic Release Jenkins Pipeline 
  <a class="anchor" href="#SemanticReleaseJenkinsPipeline">#</a>
</h2>
<p>First I want say the inspiration I get from the 
  <a href="https://github.com/semantic-release/semantic-release">semantic-release</a> automates the whole package
release workflow including: determining the next version number, generating the release notes and publishing the package.</p>
<blockquote>
<p>😎 This removes the immediate connection between human emotions and version numbers, strictly following the Semantic Versioning specification.</p>
</blockquote>
<p>In the case I don&rsquo;t found any Maven PlugIn who works in my setup <em>out-of-the-box</em> and I am running here in a <code>Maven Slave</code> and don&rsquo;t want create a<code> Maven-Node Slave</code>
I chose to follow a setup with just Git commands and a combination with the 
  <a href="https://github.com/jgitver/jgitver-maven-plugin">jgitver-maven-plugin</a>.</p>
<p>
  <img src="/static/semantic-release-delivery-pipeline/okd-customer-service-pipeline.png" alt="okd-customer-service-pipeline" /></p>
<p>After pushing some code in the <code>customer-service</code> repository the Jenkins pipeline start run.
It will be tag the source repository if needed based on the commit message inspired on the follow 
  <a href="https://github.com/semantic-release/semantic-release#commit-message-format">commit message format</a>.</p>
<blockquote>
<p>⚠️ <strong>Commit Message Format</strong>: Current version 1.0.0 will change the version like:</p>
<p>Major version (2.0.0) 👉🏼 breaking:|major:|BREAKING CHANGE:</p>
<p>Minor version (1.1.0) 👉🏼 feature:|minor:|feat:</p>
<p>Patch version (1.0.1) 👉🏼 fix:|patch:|docs:|style:|refactor:|perf:|test:|chore:</p>
</blockquote>
<p>It will also create the image tags if needed.</p>
<p>
  <img src="/static/semantic-release-delivery-pipeline/okd-customer-service-image-tags.png" alt="okd-customer-service-image-tags" /></p>
<p>Take also a look at the 
  <a href="https://jenkins.io/projects/blueocean/">Jenkins BlueOcean</a> pipeline.</p>
<p>
  <img src="/static/semantic-release-delivery-pipeline/blueocean-customer-service-pipeline.png" alt="blueocean-customer-service-pipeline" /></p>
<p>Or at the deployed <em>customer-service</em>.</p>
<p>
  <a href="http://customer-service-production.apps.c3smonkey.ch/swagger-ui.html">Customer Service Swagger</a>

  <img src="/static/semantic-release-delivery-pipeline/customer-service-swagger.png" alt="customer-service-swagger.png" /></p>
<p>The <em>changelog</em> you can find under 
  <a href="https://jenkins-jenkins.apps.c3smonkey.ch/job/jenkins/job/jenkins-customer-service-pipeline/lastSuccessfulBuild/artifact/target/changelog.html">Changelog</a></p>
<p>I know the above pipeline is a bit chatty because of this I explain my steps here a bit compromised in some pipeline steps.
Ok let&rsquo;s create a  <em>Jenkinsfile</em> in your project repository I prefer to put the <em>Jenkinsfile</em> in a folder <em>jenkins</em>.</p>
<p>First we configure a <em>Maven Slave</em> for this we configure the <em>agent node</em> with the laben <code>maven</code> because our porject is a Maven project.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span>pipeline <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Agent Maven
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    agent <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        node <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            label <span style="color:#e6db74">&#39;maven&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>Now lets define some <em>environment</em> variables we can parameterize the pipeline also for other projects later.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span>    <span style="color:#75715e">// Environment
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    environment <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        REPOSITORY <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;github.com/marzelwidmer/customer-service.git&#34;</span>
</span></span><span style="display:flex;"><span>        BRANCHES <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;[[name: &#39;*/master&#39;]]&#34;</span>
</span></span><span style="display:flex;"><span>        GIT_TAG_MESSAGE <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;ci-release-bot&#39;</span>
</span></span><span style="display:flex;"><span>        GIT_TAG_USER_EMAIL <span style="color:#f92672">=</span>  <span style="color:#e6db74">&#34;jenkins@c3smonkey.ch&#34;</span>
</span></span><span style="display:flex;"><span>        GIT_TAG_USER_NAME <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Jenkins&#34;</span>
</span></span><span style="display:flex;"><span>        DEV_ENVIRONMENT <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;development&#39;</span>
</span></span><span style="display:flex;"><span>        TEST_ENVIRONMENT <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;testing&#39;</span>
</span></span><span style="display:flex;"><span>        PROD_ENVIRONMENT <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;production&#39;</span>
</span></span><span style="display:flex;"><span>        APP_NAME <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;customer-service&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span></code></pre></div><p>(1) The following step will first check the last <em>GIT_COMMIT ID</em> and download a <em>ci-semver.sh</em> script who is hosted in a other central repository who can used for central <code>CI/CD</code> scripts across different
project Git repositories.</p>
<p>(2) This shell script will then check the Git history if there a commit message who match our Semantic Version naming convention to compute the next version.</p>
<p>(3) The next command will then call the <em>Maven</em> build and test lifecycle and use the 
  <a href="https://github.com/jgitver/jgitver">jgitver</a> plugin to pass the version we get before from the
<em>ci-semver.sh</em> script.</p>
<blockquote>
<p>💡 <strong>jgitver</strong>: 
  <a href="https://www.youtube.com/watch?v=mQmH_Ws9GFI">https://www.youtube.com/watch?v=mQmH_Ws9GFI</a></p>
</blockquote>
<p>(4) This section will store our <em>JUnit</em> test results in the Jenkins.</p>
<p>(5) Tag Git repository if needed.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span>    <span style="color:#75715e">// Stages
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    stages <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Setup
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;build and test application&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                script <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">// Last Git commit
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                    LAST_GIT_COMMIT <span style="color:#f92672">=</span> sh<span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>                            script: <span style="color:#e6db74">&#39;git --no-pager show -s --format=\&#39;%Cblue %h %Creset %s %Cgreen %an %Creset (%ae)\&#39;&#39;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                            returnStdout: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">).</span><span style="color:#a6e22e">trim</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>                    echo <span style="color:#e6db74">&#34;Last Git commit: ${LAST_GIT_COMMIT}&#34;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">// Download script  (1)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                    sh <span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        echo download ci-semver.sh script from remote repository
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        curl https://raw.githubusercontent.com/marzelwidmer/git-semantic-commits/master/ci-semver.sh  --output ./jenkins/ci-semver.sh
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        chmod +x ./jenkins/ci-semver.sh
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">// Compute next version (2)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                    NEXT_VERSION <span style="color:#f92672">=</span> sh<span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>                            script: <span style="color:#e6db74">&#34;./jenkins/ci-semver.sh&#34;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                            returnStdout: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">).</span><span style="color:#a6e22e">trim</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>                    echo <span style="color:#e6db74">&#34;NEXT_VERSION : ${NEXT_VERSION}&#34;</span>
</span></span><span style="display:flex;"><span>                    withCredentials<span style="color:#f92672">([</span>usernamePassword<span style="color:#f92672">(</span>credentialsId: <span style="color:#e6db74">&#39;jenkins-ci-user-at-github&#39;</span><span style="color:#f92672">,</span> usernameVariable: <span style="color:#e6db74">&#39;USERNAME&#39;</span><span style="color:#f92672">,</span> passwordVariable: <span style="color:#e6db74">&#39;TOKEN&#39;</span><span style="color:#f92672">)])</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        git<span style="color:#f92672">(</span>branches: <span style="color:#e6db74">&#34;$BRANCHES&#34;</span><span style="color:#f92672">,</span> changelog: <span style="color:#66d9ef">true</span><span style="color:#f92672">,</span> url: <span style="color:#e6db74">&#34;https://$TOKEN:x-oauth-basic@$REPOSITORY&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">// Maven build and test (3)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                    sh<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        echo next version will be $NEXT_VERSION
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        ./mvnw validate
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        ./mvnw validate -Djgitver.use-version=$NEXT_VERSION
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        ./mvnw package -DskipTests -Djgitver.use-version=$NEXT_VERSION
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        echo &#34;run tests&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        sh &#39;./mvnw test&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    &#34;&#34;&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">// Store Junit results (4)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                    post <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        always <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                            junit <span style="color:#e6db74">&#39;target/surefire-reports/*.xml&#39;</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">// Tag Git Repository (5)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                    echo <span style="color:#e6db74">&#34;Create tag with version: ${NEXT_VERSION}&#34;</span>
</span></span><span style="display:flex;"><span>                    sh<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        echo set git config for tagging
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        git config --global user.email &#39;${GIT_TAG_USER_EMAIL}&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        git config --global user.name &#39;${GIT_TAG_USER_NAME}&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        if [ \$(git tag -l $NEXT_VERSION) ]; then
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            echo tag exist already
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        else    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            git tag -a -m &#39;${GIT_TAG_MESSAGE}&#39; ${NEXT_VERSION}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            git push --follow-tags
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        fi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    &#34;&#34;&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><blockquote>
<p><strong><em>References and inspiration:</em></strong><br>

  <a href="https://github.com/openshift/jenkins-client-plugin">Jenkins Client Plugin</a>

  <a href="https://www.youtube.com/watch?v=MqsG9-HEcTw">Best Practices for Managing Docker Versions</a>

  <a href="https://dzone.com/articles/continuous-delivery-with-openshift-and-jenkins-ab">CI/CD - A/B - OpenShift - Jenkins</a>

  <a href="https://cookbook.openshift.org/building-and-deploying-from-source/how-can-i-build-from-a-private-repository-on-gitlab.html">GitLab Private Repository</a>

  <a href="https://blog.openshift.com/private-git-repositories-part-3-personal-access-tokens/">Personal Access Tokens - Private Repository</a>

  <a href="https://jenkins.io/blog/2018/05/16/pipelines-with-git-tags/">Pipelines with git tags</a>

  <a href="https://jgitver.github.io/#_goal">jgitver - goal</a>

  <a href="https://github.com/jgitver/jgitver-maven-plugin">jgitver-maven-plugin</a><br>

  <a href="https://codito.in/semantic-commits-for-git">Semantic commits for git</a>

  <a href="https://github.com/marzelwidmer/git-semantic-commits">git-semantic-commits</a>

  <a href="https://wiki.jenkins.io/display/JENKINS/semantic-versioning-plugin">Jenkins - semantic-versioning-plugin</a>

  <a href="https://wiki.jenkins.io/display/JENKINS/Git&#43;Parameter&#43;Plugin">Jenkins - Git+Parameter+Plugin</a>

  <a href="https://wilsonmar.github.io/jenkins2-pipeline/">wilsonmar - jenkins2-pipeline</a>

  <a href="https://gist.github.com/arehmandev/736daba40a3e1ef1fbe939c6674d7da8">Get Jenkins GDSL working with IntelliJ IDEA</a></p>
</blockquote>
</article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">


  <div><a class="flex align-center" href="https://github.com/alex-shpak/hugo-book/commit/363e3378e469dc2b9bc40321e93a7af0092d3da0" title='Last modified by Marcel Widmer | September 24, 2022' target="_blank" rel="noopener">
      <img src="/svg/calendar.svg" class="book-icon" alt="Calendar" />
      <span>September 24, 2022</span>
    </a>
  </div>




</div>



  <script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script>


 
        
      </footer>

      
  
  <div class="book-comments">

</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      <div class="book-toc-content">
        
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#table-of-contents">Table of contents</a>
      <ul>
        <li><a href="#SetupDeployment">Setup Deployment </a></li>
        <li><a href="#JenkinsPipeline">Jenkins Pipeline </a></li>
        <li><a href="#WebHooks">WebHooks</a></li>
        <li><a href="#privateRepo">Private Repository access with secrets</a></li>
        <li><a href="#SemanticReleaseJenkinsPipeline">Semantic Release Jenkins Pipeline </a></li>
      </ul>
    </li>
  </ul>
</nav>


 
      </div>
    </aside>
    
  </main>

  
</body>
</html>












